<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Recruita — Employee Portal</title>
  <meta name="description" content="Employee & admin portal for Recruita. Admin via Firebase Auth. Employees via ID + password.">

  <style>
  :root{--blue:#2B7FFF;--bg:#f7fafc;--muted:#556;--card:#fff}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#111}
  .wrap{max-width:1100px;margin:24px auto;padding:18px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  h1{margin:0;font-size:20px}
  .grid{display:grid;gap:12px}
  .auth, .panel, .card{background:var(--card);padding:16px;border-radius:10px;border:1px solid #e6eef9}
  input, textarea, select, button{font-family:inherit}
  input, textarea, select{width:100%;padding:10px;border:1px solid #e6eef9;border-radius:8px}
  button{background:var(--blue);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
  .muted{color:var(--muted);font-size:13px}
  .row{display:flex;gap:12px}
  .small-btn{background:#fff;color:var(--blue);border:1px solid var(--blue);padding:8px 10px;border-radius:8px;cursor:pointer}
  .entry{padding:10px;border-radius:8px;border:1px solid #eef6ff;background:#fbfdff;margin-bottom:8px}
  .hide{display:none}
  .status-global{border-radius:8px;padding:12px;margin:12px 0;font-weight:600}
  .status-ok{background:#e6ffef;color:#084b2b;border:1px solid #b7f3d0}
  .status-error{background:#ffecec;color:#7a1414;border:1px solid #f2c6c6}
  .badge{display:inline-block;padding:6px 10px;border-radius:8px;background:#f1f5ff;color:var(--blue);font-weight:600;margin-left:8px}
  .msg{margin-top:12px;padding:10px;border-radius:8px;border:1px solid #eee;background:#fff;color:#333}
  .msg.error{border-color:#f2c6c6;background:#fff0f0;color:#7a1414}
  .msg.ok{border-color:#d1f0d8;background:#f6fff8;color:#0b5d2e}
  @media(max-width:820px){ .row{flex-direction:column} header{flex-direction:column;align-items:flex-start} }
  </style>

  <!-- Firebase compat SDKs (must load before you call initializeApp) -->
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore-compat.js"></script>

  <!-- small utility (xlsx used by exports) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- your firebase config file (must set window.firebaseConfig) -->
  <script src="./firebase-config.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Recruita — Employee Portal</h1>
        <div class="muted">Admin login via Firebase Auth. Employees login using Employee ID + password.</div>
      </div>
    </header>

    <!-- global status -->
    <div id="globalStatus" class="status-global status-error">
      Checking Firebase SDK... <span id="sdkType" class="badge">...</span>
    </div>

    <div style="display:flex;gap:12px;margin-bottom:12px">
      <button id="tabEmployee" class="small-btn">Employee Login</button>
      <button id="tabAdmin" class="small-btn">Admin Login</button>
    </div>

    <!-- EMPLOYEE -->
    <div id="employeeSection">
      <div id="empAuth" class="auth grid">
        <strong>Employee Login (ID + Password)</strong>
        <input id="empId" placeholder="Employee ID (e.g. EMP001)">
        <input id="empPassword" type="password" placeholder="Password">
        <div style="display:flex;gap:8px">
          <button id="empLoginBtn">Login</button>
          <button id="empLogoutBtn" class="small-btn hide">Logout</button>
        </div>
        <div id="empAuthMsg" class="msg"></div>
      </div>

      <div id="empPanel" class="panel hide">
        <div style="display:flex;justify-content:space-between">
          <div>
            <strong id="empWelcome"></strong>
            <div id="empWelcomeSub" class="muted"></div>
          </div>
          <div style="display:flex;gap:8px">
            <button id="empRefresh" class="small-btn">Refresh</button>
            <button id="empLogoutTop" class="small-btn">Logout</button>
          </div>
        </div>

        <hr/>

        <div class="grid">
          <div class="card">
            <strong>Submit Candidate Entry</strong>
            <form id="empForm" style="margin-top:8px" autocomplete="off">
              <div class="row">
                <div style="flex:1"><label class="muted">Name</label><input name="candidateName"></div>
                <div style="width:150px"><label class="muted">Contact</label><input name="contactNo"></div>
              </div>

              <div class="row" style="margin-top:8px">
                <div style="width:100px"><label class="muted">Age</label><input name="age"></div>
                <div style="flex:1"><label class="muted">CTC</label><input name="currentCTC"></div>
                <div style="flex:1"><label class="muted">Company</label><input name="currentCompany"></div>
              </div>

              <div style="margin-top:8px;display:flex;gap:8px">
                <button type="submit">Submit</button>
                <button id="empClear" type="button" class="small-btn">Clear</button>
              </div>

              <div id="empFormMsg" class="msg"></div>
            </form>
          </div>

          <div class="card">
            <strong>Your Entries</strong>
            <div id="empEntries" style="margin-top:10px;max-height:350px;overflow:auto"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ADMIN -->
    <div id="adminSection" class="hide">
      <div id="adminAuth" class="auth grid">
        <strong>Admin Login</strong>
        <input id="adminEmail" placeholder="Admin email">
        <input id="adminPwd" type="password" placeholder="Password">
        <div style="display:flex;gap:8px">
          <button id="adminLoginBtn">Sign in</button>
          <button id="adminLogoutBtn" class="small-btn hide">Logout</button>
        </div>
        <div id="adminAuthMsg" class="msg"></div>
      </div>

      <div id="adminPanel" class="panel hide">
        <strong id="adminWelcome"></strong>
        <hr/>

        <div class="grid">
          <div class="card">
            <strong>Create / Update Employee</strong>
            <input id="newEmpId" placeholder="Employee ID">
            <input id="newEmpName" placeholder="Name">
            <input id="newEmpPwd" placeholder="Password">
            <div style="display:flex;gap:8px;margin-top:10px">
              <button id="createEmpBtn">Save</button>
              <button id="deleteEmpBtn" class="small-btn" style="color:red;border-color:red;">Delete</button>
            </div>
            <div id="createEmpMsg" class="msg"></div>
          </div>

          <div class="card">
            <strong>Reset Employee Password</strong>
            <input id="resetEmpId" placeholder="Employee ID">
            <input id="resetNewPwd" placeholder="New password">
            <button id="resetPwdBtn" style="margin-top:10px">Reset</button>
            <div id="resetMsg" class="msg"></div>
          </div>

          <div class="card">
            <strong>All Entries</strong>
            <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
              <button id="showAllEntriesBtn" class="small-btn">Show All</button>
              <button id="downloadAllCsv" class="small-btn">CSV</button>
              <button id="downloadAllXlsx">Excel</button>
              <button id="clearAllDisplay" class="small-btn">Clear</button>
            </div>
            <div id="allEntries" style="margin-top:10px;max-height:340px;overflow:auto"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  /* Defensive app script.
     REQUIREMENTS:
     - firebase SDKs loaded above
     - this folder contains firebase-config.js which sets window.firebaseConfig (plain script)
  */

  function setGlobalStatus(ok, text) {
    const el = document.getElementById('globalStatus');
    if (!el) return;
    el.classList.remove('status-error','status-ok');
    el.classList.add(ok ? 'status-ok' : 'status-error');
    const badge = (typeof firebase !== 'undefined') ? 'firebase: yes' : 'firebase: no';
    el.innerHTML = text + ' <span id="sdkType" class="badge">' + badge + '</span>';
  }

  function setMsg(id, text, type='') {
    const el = document.getElementById(id);
    if(!el) return;
    el.textContent = text;
    el.className = 'msg' + (type === 'error' ? ' error' : (type === 'ok' ? ' ok' : ''));
  }

  window.addEventListener('load', async () => {
    // quick checks
    const sdkPresent = (typeof firebase !== 'undefined');
    document.getElementById('sdkType').textContent = sdkPresent ? 'firebase: yes' : 'firebase: no';

    if(!sdkPresent) {
      setGlobalStatus(false, 'Firebase SDK not loaded. Check the <script> tags.');
      setMsg('empAuthMsg','Firebase not available. Login disabled.','error');
      setMsg('adminAuthMsg','Firebase not available. Login disabled.','error');
      return;
    }

    // config: allow either firebaseConfig var or window.firebaseConfig
    const cfg = (typeof firebaseConfig !== 'undefined') ? firebaseConfig : (window.firebaseConfig || null);
    if(!cfg) {
      setGlobalStatus(false, 'Firebase configuration not found (firebase-config.js).');
      setMsg('empAuthMsg','Firebase config missing. Login disabled.','error');
      setMsg('adminAuthMsg','Firebase config missing. Login disabled.','error');
      return;
    }

    try {
      firebase.initializeApp(cfg);
      const auth = firebase.auth();
      const db = firebase.firestore();

      setGlobalStatus(true, 'Firebase loaded — auth & firestore available.');

      // tabs
      const tabEmployee = document.getElementById('tabEmployee');
      const tabAdmin = document.getElementById('tabAdmin');
      tabEmployee.onclick = ()=>{ document.getElementById('employeeSection').style.display="block"; document.getElementById('adminSection').style.display="none"; };
      tabAdmin.onclick = ()=>{ document.getElementById('employeeSection').style.display="none"; document.getElementById('adminSection').style.display="block"; };

      /* EMPLOYEE LOGIN */
      const empIdInput = document.getElementById('empId');
      const empPassInput = document.getElementById('empPassword');
      const empLoginBtn = document.getElementById('empLoginBtn');
      const empLogoutBtn = document.getElementById('empLogoutBtn');
      const empLogoutTop = document.getElementById('empLogoutTop');
      const empPanel = document.getElementById('empPanel');

      empLoginBtn.addEventListener('click', async () => {
        setMsg('empAuthMsg', 'Checking credentials...', '');
        const id = empIdInput.value.trim();
        const pwd = empPassInput.value.trim();
        if(!id || !pwd){ setMsg('empAuthMsg','Enter ID & Password','error'); return; }

        try {
          const doc = await db.collection("employees").doc(id).get();
          if(!doc.exists){ setMsg('empAuthMsg','Employee not found','error'); return; }
          const data = doc.data();
          const actualPwd = data.password || data.pwd || data.pass;
          if(actualPwd !== pwd){ setMsg('empAuthMsg','Incorrect password','error'); return; }

          // success
          setMsg('empAuthMsg','Login success','ok');
          const currentEmployee = { employeeId: id, name: data.name || '' };
          localStorage.setItem("employeeSession", JSON.stringify(currentEmployee));
          document.getElementById('empAuth').classList.add("hide");
          empPanel.classList.remove("hide");
          empLogoutBtn.classList.remove("hide");
          empLogoutTop.classList.remove("hide");
          document.getElementById('empWelcome').textContent = "Welcome " + (currentEmployee.name || currentEmployee.employeeId);
          document.getElementById('empWelcomeSub').textContent = currentEmployee.employeeId;
          startEmployeeListener(db, id);

        } catch (err) {
          console.error('Employee login error:', err);
          setMsg('empAuthMsg', 'Error checking employee: ' + (err.message || err), 'error');
        }
      });

      function startEmployeeListener(dbRef, id){
        dbRef.collection("entries")
          .where("employeeId","==",id)
          .orderBy("createdAt","desc")
          .onSnapshot(snap=>{
            const empEntries = document.getElementById('empEntries');
            empEntries.innerHTML = '';
            if(snap.empty){ empEntries.innerHTML = "<div class='muted'>No entries yet</div>"; return; }
            snap.forEach(doc=>{
              const d = doc.data();
              const created = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate().toLocaleString() : '';
              const block = document.createElement('div');
              block.className = 'entry';
              block.innerHTML = `<strong>${d.candidateName||'-'}</strong>
                <div class='muted'>${created}</div>
                <div class='muted'>Contact: ${d.contactNo || ''}</div>
                <div class='muted'>Company: ${d.currentCompany || ''}</div>`;
              empEntries.appendChild(block);
            });
          }, err=>{
            console.error('listener err', err);
            setMsg('empFormMsg','Error listening entries: ' + (err.message||err),'error');
          });
      }

      document.getElementById('empForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const stored = localStorage.getItem('employeeSession');
        if(!stored){ setMsg('empFormMsg','Login required','error'); return; }
        const currentEmployee = JSON.parse(stored);
        const formData = Object.fromEntries(new FormData(e.target).entries());
        for(const k in formData){ if(formData[k]==="") formData[k]=null; }
        try {
          await db.collection("entries").add({
            employeeId: currentEmployee.employeeId,
            employeeName: currentEmployee.name,
            ...formData,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          setMsg('empFormMsg','Saved','ok');
          e.target.reset();
        } catch(err){
          console.error('save entry err', err);
          setMsg('empFormMsg','Save failed: '+(err.message||err),'error');
        }
      });

      document.getElementById('empClear').onclick = ()=> document.getElementById('empForm').reset();

      /* ADMIN LOGIN & FEATURES */
      const adminEmail = document.getElementById('adminEmail');
      const adminPwd = document.getElementById('adminPwd');
      const adminLoginBtn = document.getElementById('adminLoginBtn');
      const adminLogoutBtnEl = document.getElementById('adminLogoutBtn');
      const adminPanel = document.getElementById('adminPanel');

      auth.onAuthStateChanged(async (user)=>{
        if(!user){
          adminPanel.classList.add('hide');
          document.getElementById('adminAuth').classList.remove('hide');
          adminLogoutBtnEl.classList.add('hide');
          return;
        }
        try {
          const doc = await db.collection("admins").doc(user.email).get();
          if(!doc.exists){ setMsg('adminAuthMsg','Not authorized','error'); await auth.signOut(); return; }
          document.getElementById('adminAuth').classList.add('hide');
          adminPanel.classList.remove('hide');
          adminLogoutBtnEl.classList.remove('hide');
          document.getElementById('adminWelcome').textContent = 'Admin: ' + user.email;
          setMsg('adminAuthMsg','Signed in as admin','ok');
        } catch(err){
          console.error('admin auth state error', err);
          setMsg('adminAuthMsg','Error fetching admin record','error');
        }
      });

      adminLoginBtn.addEventListener('click', async ()=>{
        setMsg('adminAuthMsg','Signing in...','');
        try { await auth.signInWithEmailAndPassword(adminEmail.value.trim(), adminPwd.value.trim()); }
        catch(err){ console.error('admin sign in err', err); setMsg('adminAuthMsg', err.message || 'Sign-in failed', 'error'); }
      });

      adminLogoutBtnEl.onclick = ()=> auth.signOut();

      // employee CRUD & exports (same as your flow)
      document.getElementById('createEmpBtn').onclick = async ()=>{
        const id = document.getElementById('newEmpId').value.trim();
        const name = document.getElementById('newEmpName').value.trim();
        const pwd = document.getElementById('newEmpPwd').value.trim();
        if(!id || !pwd){ setMsg('createEmpMsg','ID + Password required','error'); return; }
        try { await db.collection('employees').doc(id).set({name, password:pwd, pwd:pwd}); setMsg('createEmpMsg','Saved','ok'); }
        catch(err){ console.error('create emp err', err); setMsg('createEmpMsg','Save failed: '+(err.message||err),'error'); }
      };

      document.getElementById('deleteEmpBtn').onclick = async ()=>{
        const id = document.getElementById('newEmpId').value.trim();
        if(!id){ setMsg('createEmpMsg','Provide Employee ID','error'); return; }
        try { await db.collection('employees').doc(id).delete(); setMsg('createEmpMsg','Deleted','ok'); }
        catch(err){ console.error('delete emp err', err); setMsg('createEmpMsg','Delete failed: '+(err.message||err),'error'); }
      };

      document.getElementById('resetPwdBtn').onclick = async ()=>{
        const id = document.getElementById('resetEmpId').value.trim();
        const pwd = document.getElementById('resetNewPwd').value.trim();
        if(!id || !pwd){ setMsg('resetMsg','Provide ID + New password','error'); return; }
        try { await db.collection('employees').doc(id).update({password:pwd, pwd:pwd}); setMsg('resetMsg','Updated','ok'); }
        catch(err){ console.error('reset pwd err', err); setMsg('resetMsg','Update failed: '+(err.message||err),'error'); }
      };

      document.getElementById('showAllEntriesBtn').onclick = async ()=>{
        try {
          const snap = await db.collection('entries').orderBy('createdAt','asc').get();
          const allEntries = document.getElementById('allEntries');
          allEntries.innerHTML = '';
          snap.forEach(doc=>{
            const d = doc.data();
            const created = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate().toLocaleString() : '';
            const block = document.createElement('div');
            block.className = 'entry';
            block.innerHTML = `<strong>${d.candidateName||'-'}</strong>
              <div class='muted'>${created}</div>
              <div class='muted'>${d.employeeId} — ${d.employeeName}</div>`;
            allEntries.appendChild(block);
          });
        } catch(err){ console.error('show all entries err', err); setMsg('createEmpMsg','Failed to fetch entries: '+(err.message||err),'error'); }
      };

      document.getElementById('clearAllDisplay').onclick = ()=> document.getElementById('allEntries').innerHTML='';

      // CSV / XLSX exports
      document.getElementById('downloadAllCsv').onclick = async ()=>{
        try {
          const snap = await db.collection('entries').orderBy('createdAt','asc').get();
          const rows=[["createdAt","employeeId","employeeName","candidateName","contactNo","currentCompany"]];
          snap.forEach(doc=>{
            const d=doc.data();
            rows.push([ d.createdAt ? d.createdAt.toDate().toISOString() : "", d.employeeId, d.employeeName, d.candidateName, d.contactNo, d.currentCompany ]);
          });
          const csv = rows.map(r=>r.map(v=> (typeof v === 'string' && v.includes(',')) ? `"${v.replace(/"/g,'""')}"` : v ).join(",")).join("\n");
          const blob = new Blob([csv],{type:'text/csv'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href = url; a.download = 'recruita_entries.csv'; a.click(); URL.revokeObjectURL(url);
        } catch(err){ console.error('csv err', err); setMsg('createEmpMsg','CSV export failed: '+(err.message||err),'error'); }
      };

      document.getElementById('downloadAllXlsx').onclick = async ()=>{
        try {
          const snap = await db.collection('entries').orderBy('createdAt','asc').get();
          const rows=[["createdAt","employeeId","employeeName","candidateName","contactNo","currentCompany"]];
          snap.forEach(doc=>{
            const d=doc.data();
            rows.push([ d.createdAt ? d.createdAt.toDate().toISOString() : "", d.employeeId, d.employeeName, d.candidateName, d.contactNo, d.currentCompany ]);
          });
          const wb = XLSX.utils.book_new();
          const ws = XLSX.utils.aoa_to_sheet(rows);
          XLSX.utils.book_append_sheet(wb, ws, 'entries');
          XLSX.writeFile(wb, 'recruita_entries.xlsx');
        } catch(err){ console.error('xlsx err', err); setMsg('createEmpMsg','Excel export failed: '+(err.message||err),'error'); }
      };

    } catch(initErr){
      console.error('Firebase init error:', initErr);
      setGlobalStatus(false, 'Firebase initialization failed. Check config.');
      setMsg('empAuthMsg','Auth not available. Check Firebase setup.','error');
      setMsg('adminAuthMsg','Auth not available. Check Firebase setup.','error');
    }

  }); // load
  </script>
</body>
</html>
