<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Recruita — Employee Portal</title>
  <meta name="description" content="Employee & admin portal for Recruita. Admin via Firebase Auth. Employees login using Employee ID + password.">

  <!-- --------------------------- -->
  <!-- 1. LOAD FIREBASE SDKs FIRST -->
  <!-- --------------------------- -->
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore-compat.js"></script>

  <!-- Excel Export Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- --------------------------------- -->
  <!-- 2. LOAD YOUR FIREBASE CONFIG FILE -->
  <!-- --------------------------------- -->
  <!-- This must come AFTER the SDKs -->
  <script src="firebase-config.js"></script>

  <style>
    :root{--blue:#2B7FFF;--bg:#f7fafc;--muted:#556;--card:#fff}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#111}
    .wrap{max-width:1100px;margin:24px auto;padding:18px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    h1{margin:0;font-size:20px}
    .grid{display:grid;gap:12px}
    .auth,.panel,.card{background:var(--card);padding:16px;border-radius:10px;border:1px solid #e6eef9}
    input,textarea,select,button{font-family:inherit}
    input,textarea,select{width:100%;padding:10px;border:1px solid #e6eef9;border-radius:8px}
    button{background:var(--blue);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;gap:12px}
    .small-btn{background:#fff;color:var(--blue);border:1px solid var(--blue);padding:8px 10px;border-radius:8px;cursor:pointer}
    .entry{padding:10px;border-radius:8px;border:1px solid #eef6ff;background:#fbfdff;margin-bottom:8px}
    .hide{display:none}
    .status-global{border-radius:8px;padding:12px;margin:12px 0;font-weight:600}
    .status-ok{background:#e6ffef;color:#084b2b;border:1px solid #b7f3d0}
    .status-error{background:#ffecec;color:#7a1414;border:1px solid #f2c6c6}
    .badge{display:inline-block;padding:6px 10px;border-radius:8px;background:#f1f5ff;color:var(--blue);font-weight:600;margin-left:8px}
    .msg{margin-top:12px;padding:10px;border-radius:8px;border:1px solid #eee;background:#fff;color:#333}
    .msg.error{border-color:#f2c6c6;background:#fff0f0;color:#7a1414}
    .msg.ok{border-color:#d1f0d8;background:#f6fff8;color:#0b5d2e}
    @media(max-width:820px){ .row{flex-direction:column} header{flex-direction:column;align-items:flex-start} }
  </style>

</head>
<body>

<div class="wrap">

  <header>
    <div>
      <h1>Recruita — Employee Portal</h1>
      <div class="muted">Admin login via Firebase Auth. Employees login using Employee ID + password.</div>
    </div>
  </header>

  <!-- Global Firebase Status -->
  <div id="globalStatus" class="status-global status-error">
    Checking Firebase SDK... <span id="sdkType" class="badge">...</span>
  </div>

  <div style="display:flex;gap:12px;margin-bottom:12px">
    <button id="tabEmployee" class="small-btn">Employee Login</button>
    <button id="tabAdmin" class="small-btn">Admin Login</button>
  </div>

  <!-- EMPLOYEE SECTION -->
  <div id="employeeSection">
    <div id="empAuth" class="auth grid">
      <strong>Employee Login (ID + Password)</strong>
      <input id="empId" placeholder="Employee ID (e.g. EMP001)">
      <input id="empPassword" type="password" placeholder="Password">
      <div style="display:flex;gap:8px">
        <button id="empLoginBtn">Login</button>
        <button id="empLogoutBtn" class="small-btn hide">Logout</button>
      </div>
      <div id="empAuthMsg" class="msg"></div>
    </div>

    <div id="empPanel" class="panel hide">
      <div style="display:flex;justify-content:space-between">
        <div>
          <strong id="empWelcome"></strong>
          <div id="empWelcomeSub" class="muted"></div>
        </div>
        <div style="display:flex;gap:8px">
          <button id="empRefresh" class="small-btn">Refresh</button>
          <button id="empLogoutTop" class="small-btn">Logout</button>
        </div>
      </div>

      <hr/>

      <div class="grid">
        <div class="card">
          <strong>Submit Candidate Entry</strong>
          <form id="empForm" autocomplete="off" style="margin-top:8px">
            <div class="row">
              <div style="flex:1"><label class="muted">Name</label><input name="candidateName"></div>
              <div style="width:150px"><label class="muted">Contact</label><input name="contactNo"></div>
            </div>

            <div class="row" style="margin-top:8px">
              <div style="width:100px"><label class="muted">Age</label><input name="age"></div>
              <div style="flex:1"><label class="muted">CTC</label><input name="currentCTC"></div>
              <div style="flex:1"><label class="muted">Company</label><input name="currentCompany"></div>
            </div>

            <div style="margin-top:8px;display:flex;gap:8px">
              <button type="submit">Submit</button>
              <button id="empClear" type="button" class="small-btn">Clear</button>
            </div>

            <div id="empFormMsg" class="msg"></div>
          </form>
        </div>

        <div class="card">
          <strong>Your Entries</strong>
          <div id="empEntries" style="margin-top:10px;max-height:350px;overflow:auto"></div>
        </div>

      </div>
    </div>
  </div>

  <!-- ADMIN SECTION -->
  <div id="adminSection" class="hide">

    <div id="adminAuth" class="auth grid">
      <strong>Admin Login</strong>
      <input id="adminEmail" placeholder="Admin email">
      <input id="adminPwd" type="password" placeholder="Password">
      <div style="display:flex;gap:8px">
        <button id="adminLoginBtn">Sign in</button>
        <button id="adminLogoutBtn" class="small-btn hide">Logout</button>
      </div>
      <div id="adminAuthMsg" class="msg"></div>
    </div>

    <div id="adminPanel" class="panel hide">
      <strong id="adminWelcome"></strong>
      <hr/>

      <div class="grid">

        <div class="card">
          <strong>Create / Update Employee</strong>
          <input id="newEmpId" placeholder="Employee ID">
          <input id="newEmpName" placeholder="Name">
          <input id="newEmpPwd" placeholder="Password">
          <div style="display:flex;gap:8px;margin-top:10px">
            <button id="createEmpBtn">Save</button>
            <button id="deleteEmpBtn" class="small-btn" style="color:red;border-color:red;">Delete</button>
          </div>
          <div id="createEmpMsg" class="msg"></div>
        </div>

        <div class="card">
          <strong>Reset Password</strong>
          <input id="resetEmpId" placeholder="Employee ID">
          <input id="resetNewPwd" placeholder="New password">
          <button id="resetPwdBtn" style="margin-top:10px">Reset</button>
          <div id="resetMsg" class="msg"></div>
        </div>

        <div class="card">
          <strong>All Entries</strong>
          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
            <button id="showAllEntriesBtn" class="small-btn">Show All</button>
            <button id="downloadAllCsv" class="small-btn">CSV</button>
            <button id="downloadAllXlsx">Excel</button>
            <button id="clearAllDisplay" class="small-btn">Clear</button>
          </div>
          <div id="allEntries" style="margin-top:10px;max-height:340px;overflow:auto"></div>
        </div>

      </div>
    </div>
  </div>

</div>

<script>
/* ---------------- STATUS + MESSAGE HELPERS ---------------- */

function setGlobalStatus(ok, text) {
  const el = document.getElementById('globalStatus');
  const sdk = (typeof firebase !== 'undefined') ? 'firebase: yes' : 'firebase: no';
  el.classList.remove('status-error','status-ok');
  el.classList.add(ok ? 'status-ok' : 'status-error');
  el.innerHTML = text + ' <span id="sdkType" class="badge">' + sdk + '</span>';
}

function setMsg(id, text, type='') {
  const el = document.getElementById(id);
  if(!el) return;
  el.textContent = text;
  el.className = 'msg' + (type==='error'?' error':type==='ok'?' ok':'');
}

/* ---------------- MAIN APP LOGIC ---------------- */

window.addEventListener('load', async ()=>{

  if(typeof firebase === 'undefined'){
    setGlobalStatus(false, 'Firebase SDK not loaded. Check script order.');
    setMsg('empAuthMsg','Firebase not available.','error');
    return;
  }

  const cfg = window.firebaseConfig;
  if(!cfg){
    setGlobalStatus(false, 'firebase-config.js not loaded.');
    return;
  }

  try {
    firebase.initializeApp(cfg);
    const auth = firebase.auth();
    const db = firebase.firestore();

    setGlobalStatus(true,'Firebase connected.');

    /* ---------------- TABS ---------------- */
    tabEmployee.onclick = ()=>{ employeeSection.style.display='block'; adminSection.style.display='none'; };
    tabAdmin.onclick = ()=>{ employeeSection.style.display='none'; adminSection.style.display='block'; };

    /* ---------------- EMPLOYEE LOGIN ---------------- */
    empLoginBtn.onclick = async ()=>{
      const id = empId.value.trim();
      const pwd = empPassword.value.trim();
      if(!id || !pwd){ setMsg('empAuthMsg','Enter ID + Password','error'); return; }

      const doc = await db.collection("employees").doc(id).get();
      if(!doc.exists){ setMsg('empAuthMsg','Employee not found','error'); return; }

      const data = doc.data();
      const correctPwd = data.password || data.pwd;
      if(correctPwd !== pwd){ setMsg('empAuthMsg','Incorrect password','error'); return; }

      setMsg('empAuthMsg','Login successful','ok');

      empAuth.classList.add("hide");
      empPanel.classList.remove("hide");
      empLogoutBtn.classList.remove("hide");
      empLogoutTop.classList.remove("hide");

      empWelcome.textContent = "Welcome " + (data.name || id);
      empWelcomeSub.textContent = id;

      startEmployeeListener(db,id);
    };

    function startEmployeeListener(dbRef,id){
      dbRef.collection("entries")
      .where("employeeId","==",id)
      .orderBy("createdAt","desc")
      .onSnapshot(snap=>{
        empEntries.innerHTML="";
        if(snap.empty){
          empEntries.innerHTML="<div class='muted'>No entries yet</div>";
          return;
        }
        snap.forEach(doc=>{
          const d=doc.data();
          const ts=d.createdAt?.toDate().toLocaleString() || "";
          empEntries.innerHTML+=`
            <div class="entry">
              <strong>${d.candidateName||'-'}</strong>
              <div class="muted">${ts}</div>
              <div class="muted">Contact: ${d.contactNo||''}</div>
              <div class="muted">Company: ${d.currentCompany||''}</div>
            </div>`;
        });
      });
    }

    empForm.onsubmit = async (e)=>{
      e.preventDefault();
      const stored = localStorage.getItem('employeeSession');
      if(!stored){ setMsg('empFormMsg','Login required','error'); return; }

      const current = JSON.parse(stored);
      const formData = Object.fromEntries(new FormData(empForm).entries());

      await db.collection("entries").add({
        employeeId: current.employeeId,
        employeeName: current.name,
        ...formData,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      setMsg('empFormMsg','Saved','ok');
      empForm.reset();
    };

    empClear.onclick = ()=> empForm.reset();

    /* ---------------- ADMIN LOGIN ---------------- */
    adminLoginBtn.onclick = async ()=>{
      try{
        await auth.signInWithEmailAndPassword(adminEmail.value.trim(), adminPwd.value.trim());
      }catch(err){
        setMsg('adminAuthMsg', err.message,'error');
      }
    };

    auth.onAuthStateChanged(async (user)=>{
      if(!user){
        adminPanel.classList.add("hide");
        adminAuth.classList.remove("hide");
        adminLogoutBtn.classList.add("hide");
        return;
      }

      const doc = await db.collection("admins").doc(user.email).get();
      if(!doc.exists){
        setMsg('adminAuthMsg','Not authorized','error');
        auth.signOut();
        return;
      }

      adminAuth.classList.add("hide");
      adminPanel.classList.remove("hide");
      adminLogoutBtn.classList.remove("hide");
      adminWelcome.textContent = "Admin: " + user.email;
    });

    adminLogoutBtn.onclick = ()=>auth.signOut();

    /* ---------------- ADMIN FEATURES ---------------- */
    createEmpBtn.onclick = async ()=>{
      const id=newEmpId.value.trim();
      const name=newEmpName.value.trim();
      const pwd=newEmpPwd.value.trim();
      if(!id || !pwd){ setMsg('createEmpMsg','ID + Password required','error'); return; }

      await db.collection('employees').doc(id).set({name,password:pwd,pwd:pwd});
      setMsg('createEmpMsg','Saved','ok');
    };

    deleteEmpBtn.onclick = async ()=>{
      const id=newEmpId.value.trim();
      if(!id){ setMsg('createEmpMsg','Enter Employee ID','error'); return; }
      await db.collection('employees').doc(id).delete();
      setMsg('createEmpMsg','Deleted','ok');
    };

    resetPwdBtn.onclick = async ()=>{
      const id=resetEmpId.value.trim();
      const pwd=resetNewPwd.value.trim();
      if(!id || !pwd){ setMsg('resetMsg','Missing fields','error'); return; }

      await db.collection('employees').doc(id).update({password:pwd,pwd:pwd});
      setMsg('resetMsg','Updated','ok');
    };

    showAllEntriesBtn.onclick = async ()=>{
      const snap = await db.collection("entries").orderBy("createdAt","asc").get();
      allEntries.innerHTML="";
      snap.forEach(doc=>{
        const d=doc.data();
        const ts=d.createdAt?.toDate().toLocaleString() || "";
        allEntries.innerHTML+=`
        <div class="entry">
          <strong>${d.candidateName||'-'}</strong>
          <div class="muted">${ts}</div>
          <div class="muted">${d.employeeId} — ${d.employeeName}</div>
        </div>`;
      });
    };

    clearAllDisplay.onclick = ()=>{ allEntries.innerHTML=""; };

    downloadAllCsv.onclick = async ()=>{
      const snap = await db.collection('entries').orderBy('createdAt','asc').get();
      const rows=[["createdAt","employeeId","employeeName","candidateName","contactNo","currentCompany"]];
      snap.forEach(doc=>{
        const d=doc.data();
        rows.push([
          d.createdAt ? d.createdAt.toDate().toISOString():"",
          d.employeeId,d.employeeName,d.candidateName,d.contactNo,d.currentCompany
        ]);
      });
      const csv = rows.map(r=>r.join(",")).join("\n");
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download="recruita_entries.csv";
      a.click();
    };

    downloadAllXlsx.onclick = async ()=>{
      const snap = await db.collection('entries').orderBy('createdAt','asc').get();
      const rows=[["createdAt","employeeId","employeeName","candidateName","contactNo","currentCompany"]];
      snap.forEach(doc=>{
        const d=doc.data();
        rows.push([
          d.createdAt ? d.createdAt.toDate().toISOString():"",
          d.employeeId,d.employeeName,d.candidateName,d.contactNo,d.currentCompany
        ]);
      });
      const wb=XLSX.utils.book_new();
      const ws=XLSX.utils.aoa_to_sheet(rows);
      XLSX.utils.book_append_sheet(wb,ws,"entries");
      XLSX.writeFile(wb,"recruita_entries.xlsx");
    };

  } catch (err){
    console.error(err);
    setGlobalStatus(false,'Firebase initialization failed.');
  }

});
</script>

</body>
</html>
