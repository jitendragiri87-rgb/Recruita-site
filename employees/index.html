<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Recruita — Employee Portal</title>
<meta name="description" content="Employee & admin portal for Recruita. Admin via Firebase Auth. Employees via ID + password.">

<style>
:root{--blue:#2B7FFF;--bg:#f7fafc;--muted:#556;--card:#fff}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#111}
.wrap{max-width:1100px;margin:24px auto;padding:18px}
header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
header img{height:46px}
h1{margin:0;font-size:20px}
.grid{display:grid;gap:12px}
.auth, .panel, .card{background:var(--card);padding:16px;border-radius:10px;border:1px solid #e6eef9}
input, textarea, select, button{font-family:inherit}
input, textarea, select{width:100%;padding:10px;border:1px solid #e6eef9;border-radius:8px}
button{background:var(--blue);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
.muted{color:var(--muted);font-size:13px}
.row{display:flex;gap:12px}
.small-btn{background:#fff;color:var(--blue);border:1px solid var(--blue);padding:8px 10px;border-radius:8px;cursor:pointer}
.entry{padding:10px;border-radius:8px;border:1px solid #eef6ff;background:#fbfdff;margin-bottom:8px}
.hide{display:none}
@media(max-width:820px){ .row{flex-direction:column} header{flex-direction:column;align-items:flex-start} }
</style>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

</head>
<body>
<div class="wrap">

<header>
  <img src="/assets/recruita-logo.png" onerror="this.style.display='none'">
  <div>
    <h1>Recruita — Employee Portal</h1>
    <div class="muted">Admin login via Firebase Auth. Employees login using Employee ID + password.</div>
  </div>
</header>

<div style="display:flex;gap:12px;margin-bottom:12px">
  <button id="tabEmployee" class="small-btn">Employee Login</button>
  <button id="tabAdmin" class="small-btn">Admin Login</button>
</div>

<!-- EMPLOYEE LOGIN SECTION -->
<div id="employeeSection">
  <div id="empAuth" class="auth grid">
    <strong>Employee Login (ID + Password)</strong>
    <input id="empId" placeholder="Employee ID (e.g. EMP001)">
    <input id="empPassword" type="password" placeholder="Password">
    <div style="display:flex;gap:8px">
      <button id="empLoginBtn">Login</button>
      <button id="empLogoutBtn" class="small-btn hide">Logout</button>
    </div>
    <div id="empAuthMsg" class="muted"></div>
  </div>

  <div id="empPanel" class="panel hide">
    <div style="display:flex;justify-content:space-between">
      <div>
        <strong id="empWelcome"></strong>
        <div id="empWelcomeSub" class="muted"></div>
      </div>
      <div style="display:flex;gap:8px">
        <button id="empRefresh" class="small-btn">Refresh</button>
        <button id="empLogoutTop" class="small-btn">Logout</button>
      </div>
    </div>

    <hr/>

    <div class="grid">
      <div class="card">
        <strong>Submit Candidate Entry</strong>
        <form id="empForm" style="margin-top:8px" autocomplete="off">
          <div class="row">
            <div style="flex:1"><label class="muted">Name</label><input name="candidateName"></div>
            <div style="width:150px"><label class="muted">Contact</label><input name="contactNo"></div>
          </div>

          <div class="row" style="margin-top:8px">
            <div style="width:100px"><label class="muted">Age</label><input name="age"></div>
            <div style="flex:1"><label class="muted">CTC</label><input name="currentCTC"></div>
            <div style="flex:1"><label class="muted">Company</label><input name="currentCompany"></input></div>
          </div>

          <div class="row" style="margin-top:8px">
            <div style="flex:1"><label class="muted">Channel</label><input name="channel"></div>
            <div style="flex:1"><label class="muted">Location</label><input name="currentLocation"></div>
            <div style="width:160px"><label class="muted">Experience</label><input name="totalExperience"></div>
          </div>

          <div style="margin-top:8px">
            <label class="muted">Call date</label>
            <input type="date" name="callDate">
          </div>

          <div style="display:flex;gap:8px;margin-top:10px">
            <button type="submit">Submit</button>
            <button id="empClear" type="button" class="small-btn">Clear</button>
          </div>

          <div id="empFormMsg" class="muted" style="margin-top:8px"></div>
        </form>
      </div>

      <div class="card">
        <strong>Your Entries</strong>
        <div id="empEntries" style="margin-top:10px;max-height:350px;overflow:auto"></div>
      </div>
    </div>
  </div>
</div>

<!-- ADMIN SECTION -->
<div id="adminSection" class="hide">

  <div id="adminAuth" class="auth grid">
    <strong>Admin Login</strong>
    <input id="adminEmail" placeholder="Admin email">
    <input id="adminPwd" type="password" placeholder="Password">
    <div style="display:flex;gap:8px">
      <button id="adminLoginBtn">Sign in</button>
      <button id="adminLogoutBtn" class="small-btn hide">Logout</button>
    </div>
    <div id="adminAuthMsg" class="muted"></div>
  </div>

  <div id="adminPanel" class="panel hide">
    <strong id="adminWelcome"></strong>
    <hr/>

    <div class="grid">
      <div class="card">
        <strong>Create / Update Employee</strong>
        <input id="newEmpId" placeholder="Employee ID">
        <input id="newEmpName" placeholder="Name">
        <input id="newEmpPwd" placeholder="Password">
        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="createEmpBtn">Save</button>
          <button id="deleteEmpBtn" class="small-btn" style="color:red;border-color:red;">Delete</button>
        </div>
        <div id="createEmpMsg" class="muted"></div>
      </div>

      <div class="card">
        <strong>Reset Employee Password</strong>
        <input id="resetEmpId" placeholder="Employee ID">
        <input id="resetNewPwd" placeholder="New password">
        <button id="resetPwdBtn" style="margin-top:10px">Reset</button>
        <div id="resetMsg" class="muted"></div>
      </div>

      <div class="card">
        <strong>All Entries</strong>
        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
          <button id="showAllEntriesBtn" class="small-btn">Show All</button>
          <button id="downloadAllCsv" class="small-btn">CSV</button>
          <button id="downloadAllXlsx">Excel</button>
          <button id="clearAllDisplay" class="small-btn">Clear</button>
        </div>
        <div id="allEntries" style="margin-top:10px;max-height:340px;overflow:auto"></div>
      </div>
    </div>

  </div>

</div>

<script>
/* ============================
   YOUR FIREBASE CONFIG
============================ */
const firebaseConfig = {
  apiKey: "AIzaSyCQi68RIeS4L5SwNQuAYFbK7KB3awrADV0",
  authDomain: "authentication-114b0.firebaseapp.com",
  projectId: "authentication-114b0",
  storageBucket: "authentication-114b0.firebasestorage.app",
  messagingSenderId: "332309567366",
  appId: "1:332309567366:web:0312c801fe2193e3debe07",
  measurementId: "G-F9PQ3DE71D"
};
  /* INIT FIREBASE */
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* UI Elements */
const tabEmployee = document.getElementById('tabEmployee');
const tabAdmin = document.getElementById('tabAdmin');

tabEmployee.onclick = ()=>{ 
  document.getElementById('employeeSection').style.display="block";
  document.getElementById('adminSection').style.display="none";
};

tabAdmin.onclick = ()=>{ 
  document.getElementById('employeeSection').style.display="none";
  document.getElementById('adminSection').style.display="block";
};

/* ============ EMPLOYEE LOGIN ============ */
const empIdInput = document.getElementById('empId');
const empPassInput = document.getElementById('empPassword');
const empLoginBtn = document.getElementById('empLoginBtn');
const empLogoutBtn = document.getElementById('empLogoutBtn');
const empLogoutTop = document.getElementById('empLogoutTop');
const empPanel = document.getElementById('empPanel');
const empAuthMsg = document.getElementById('empAuthMsg');
const empEntries = document.getElementById('empEntries');
const empFormMsg = document.getElementById('empFormMsg');
const empForm = document.getElementById('empForm');
const empWelcome = document.getElementById('empWelcome');
const empWelcomeSub = document.getElementById('empWelcomeSub');
const empRefresh = document.getElementById('empRefresh');

let currentEmployee = null;
let empUnsubListener = null;

empLoginBtn.onclick = async ()=>{
  const id = empIdInput.value.trim();
  const pwd = empPassInput.value.trim();

  if(!id || !pwd){
    empAuthMsg.textContent="Enter ID & Password";
    return;
  }

  const doc = await db.collection("employees").doc(id).get();
  if(!doc.exists){
    empAuthMsg.textContent="Employee not found";
    return;
  }

  const data = doc.data();
  if(data.password !== pwd){
    empAuthMsg.textContent="Incorrect password";
    return;
  }

  currentEmployee = { employeeId: id, name: data.name || "" };
  localStorage.setItem("employeeSession", JSON.stringify(currentEmployee));

  document.getElementById('empAuth').classList.add("hide");
  empPanel.classList.remove("hide");
  empLogoutBtn.classList.remove("hide");
  empLogoutTop.classList.remove("hide");

  empWelcome.textContent = "Welcome " + (currentEmployee.name || currentEmployee.employeeId);
  empWelcomeSub.textContent = currentEmployee.employeeId;

  startEmployeeListener(id);
};

function startEmployeeListener(id){
  if(empUnsubListener) empUnsubListener();

  empUnsubListener = db.collection("entries")
    .where("employeeId","==",id)
    .orderBy("createdAt","desc")
    .onSnapshot(snap=>{
      empEntries.innerHTML="";
      if(snap.empty){
        empEntries.innerHTML="<div class='muted'>No entries yet</div>";
        return;
      }

      snap.forEach(doc=>{
        const d=doc.data();
        const created=d.createdAt ? formatTS(d.createdAt) : "saving...";
        const block=document.createElement("div");
        block.className="entry";
        block.innerHTML = `
          <strong>${d.candidateName||'-'}</strong>
          <div class='muted'>${created}</div>
          <div class='muted'>Contact: ${d.contactNo}</div>
          <div class='muted'>Company: ${d.currentCompany}</div>
        `;
        empEntries.appendChild(block);
      });
    });
}

function formatTS(ts){
  try {
    return ts.toDate().toLocaleString();
  } catch(e){
    return "";
  }
}

empLogoutBtn.onclick = logoutEmployee;
empLogoutTop.onclick = logoutEmployee;

function logoutEmployee(){
  currentEmployee=null;
  localStorage.removeItem("employeeSession");
  if(empUnsubListener) empUnsubListener();

  empPanel.classList.add("hide");
  document.getElementById('empAuth').classList.remove("hide");
  empLogoutBtn.classList.add("hide");
  empLogoutTop.classList.add("hide");
  empEntries.innerHTML="";
}

empForm.addEventListener("submit", async (e)=>{
  e.preventDefault();

  if(!currentEmployee){
    empFormMsg.textContent="Login required";
    return;
  }

  const formData = Object.fromEntries(new FormData(empForm).entries());
  for(const k in formData){
    if(formData[k]==="") formData[k]=null;
  }

  await db.collection("entries").add({
    employeeId: currentEmployee.employeeId,
    employeeName: currentEmployee.name,
    ...formData,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  empFormMsg.textContent="Saved";
  empForm.reset();
});

empRefresh.onclick = ()=>{
  if(currentEmployee) startEmployeeListener(currentEmployee.employeeId);
};

/* ============ ADMIN LOGIN (FIREBASE AUTH) ============ */
const adminEmail = document.getElementById('adminEmail');
const adminPwd = document.getElementById('adminPwd');
const adminLoginBtn = document.getElementById('adminLoginBtn');
const adminLogoutBtnEl = document.getElementById('adminLogoutBtn');
const adminSignoutTop = document.getElementById('adminSignoutTop');
const adminPanel = document.getElementById('adminPanel');
const adminAuthMsg = document.getElementById('adminAuthMsg');
const adminWelcome = document.getElementById('adminWelcome');

auth.onAuthStateChanged(async (user)=>{
  if(!user){
    hideAdminPanel();
    return;
  }

  // Check if admin exists in Firestore /admins
  const doc = await db.collection("admins").doc(user.email).get();
  if(!doc.exists){
    adminAuthMsg.textContent="Not authorized";
    auth.signOut();
    return;
  }

  showAdminPanel(user);
});

adminLoginBtn.onclick = async ()=>{
  try{
    await auth.signInWithEmailAndPassword(adminEmail.value.trim(), adminPwd.value.trim());
  }catch(e){
    adminAuthMsg.textContent=e.message;
  }
};

function showAdminPanel(user){
  document.getElementById("adminAuth").classList.add("hide");
  adminPanel.classList.remove("hide");
  adminLogoutBtnEl.classList.remove("hide");
  adminSignoutTop.classList.remove("hide");

  adminWelcome.textContent="Admin: " + user.email;
}

function hideAdminPanel(){
  adminPanel.classList.add("hide");
  document.getElementById("adminAuth").classList.remove("hide");
  adminLogoutBtnEl.classList.add("hide");
  adminSignoutTop.classList.add("hide");
}

adminLogoutBtnEl.onclick = ()=>auth.signOut();
adminSignoutTop.onclick = ()=>auth.signOut();

/* ============ ADMIN FEATURES ============ */

// CREATE EMPLOYEE
createEmpBtn.onclick = async ()=>{
  const id=newEmpId.value.trim();
  const name=newEmpName.value.trim();
  const pwd=newEmpPwd.value.trim();

  if(!id || !pwd){
    createEmpMsg.textContent="ID + Password required";
    return;
  }

  await db.collection("employees").doc(id).set({name,pwd,password:pwd});
  createEmpMsg.textContent="Saved";
};

// DELETE EMPLOYEE
deleteEmpBtn.onclick = async ()=>{
  const id=newEmpId.value.trim();
  if(!id){
    createEmpMsg.textContent="Provide Employee ID";
    return;
  }
  await db.collection("employees").doc(id).delete();
  createEmpMsg.textContent="Deleted";
};

// RESET PASSWORD
resetPwdBtn.onclick = async ()=>{
  const id=resetEmpId.value.trim();
  const pwd=resetNewPwd.value.trim();

  if(!id || !pwd){
    resetMsg.textContent="Provide ID + New password";
    return;
  }

  await db.collection("employees").doc(id).update({password:pwd});
  resetMsg.textContent="Updated";
};

// SHOW ALL ENTRIES
showAllEntriesBtn.onclick = async ()=>{
  const snap = await db.collection("entries").orderBy("createdAt","asc").get();
  allEntries.innerHTML="";

  snap.forEach(doc=>{
    const d=doc.data();
    const created=d.createdAt ? formatTS(d.createdAt) : "";
    const block=document.createElement("div");
    block.className="entry";
    block.innerHTML = `
      <strong>${d.candidateName||'-'}</strong>
      <div class='muted'>${created}</div>
      <div class='muted'>${d.employeeId} — ${d.employeeName}</div>
    `;
    allEntries.appendChild(block);
  });
};

clearAllDisplay.onclick = ()=> allEntries.innerHTML="";

// EXPORT CSV
downloadAllCsv.onclick = async ()=>{
  const snap = await db.collection("entries").orderBy("createdAt","asc").get();
  const rows=[["createdAt","employeeId","employeeName","candidateName","contactNo","currentCompany"]];

  snap.forEach(doc=>{
    const d=doc.data();
    rows.push([
      d.createdAt ? d.createdAt.toDate().toISOString() : "",
      d.employeeId,
      d.employeeName,
      d.candidateName,
      d.contactNo,
      d.currentCompany
    ]);
  });

  const csv=rows.map(r=>r.join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="recruita_entries.csv";
  a.click();
  URL.revokeObjectURL(url);
};

// EXPORT XLSX
downloadAllXlsx.onclick = async ()=>{
  const snap = await db.collection("entries").orderBy("createdAt","asc").get();
  const rows=[["createdAt","employeeId","employeeName","candidateName","contactNo","currentCompany"]];

  snap.forEach(doc=>{
    const d=doc.data();
    rows.push([
      d.createdAt ? d.createdAt.toDate().toISOString() : "",
      d.employeeId,
      d.employeeName,
      d.candidateName,
      d.contactNo,
      d.currentCompany
    ]);
  });

  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb,ws,"entries");
  XLSX.writeFile(wb,"recruita_entries.xlsx");
};

</script>
</body>
</html>
