<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Recruita User Management</title>

<style>
body {
    background:#0b0b0c;
    color:#fff;
    font-family: Inter, sans-serif;
    padding: 20px;
}
.light { background:#f2f2f2; color:#222; }

.topBar {
    display:flex;
    justify-content:flex-start;
    gap:12px;
    margin-bottom:25px;
}

button {
    padding:10px 18px;
    border:none;
    border-radius:6px;
    cursor:pointer;
    font-weight:600;
}
.blueBtn { background:#2B7FFF; color:white; }
.redBtn { background:#e74c3c; color:white; }
.greyBtn { background:#555; color:white; }

input {
    width:100%;
    padding:12px;
    border-radius:8px;
    border:none;
    margin-top:10px;
    background:#111;
    color:white;
}
.light input { background:white; color:#222; border:1px solid #ccc; }

.tableBox { overflow-x:auto; margin-top:20px; }

table {
    width:100%;
    border-collapse: collapse;
    margin-top:15px;
}
th, td {
    padding:10px;
    border:1px solid #333;
}
.light th, .light td { border:1px solid #ccc; }

.smallNote { font-size:13px; color:rgba(255,255,255,0.7); margin-top:6px; }
</style>
</head>

<body>

<div class="topBar">
    <button class="blueBtn" onclick="goBack()">‚Üê Back</button>
    <button class="greyBtn" onclick="toggleTheme()">üåì Theme</button>
    <button class="redBtn" onclick="logout()">Logout</button>
</div>

<h2>User Management (Admin Only)</h2>

<h3>Create Recruiter</h3>

<input id="newFullName" placeholder="Full name (optional)">
<input id="newEmail" placeholder="Recruiter Email">
<input id="newPassword" placeholder="Password">

<div style="display:flex;gap:10px;margin-top:10px;">
    <button class="blueBtn" onclick="createRecruiter()">Create Recruiter</button>
    <button class="greyBtn" onclick="loadUsers()">Reload Users</button>
</div>
<div class="smallNote">EmpID will be email prefix (you can edit the full name after creation).</div>

<h2>All Users</h2>

<div class="tableBox">
<table>
    <thead>
        <tr>
            <th>EmpID</th>
            <th>Full Name</th>
            <th>Email</th>
            <th>Role</th>
            <th>UID</th>
            <th>Reset Password</th>
            <th>Edit Name</th>
            <th>Delete</th>
        </tr>
    </thead>
    <tbody id="userBody"></tbody>
</table>
</div>

<script type="module">
import { auth, db } from "./firebase.js";

import {
    createUserWithEmailAndPassword,
    sendPasswordResetEmail
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

import {
    setDoc,
    doc,
    getDocs,
    collection,
    deleteDoc,
    updateDoc
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

/* ACCESS CHECK ‚Äî Only logged-in admin can view */
auth.onAuthStateChanged(async u => {
    if(!u){
        location.href = "login.html";
        return;
    }

    let uid = u.uid;
    let userRef = doc(db,"users",uid);
    // perform a quick existence check by querying users collection by uid
    // (original relied on getDoc which needed doc path; here we do a safer read)
    // We'll simply load users and then check role
    let snap = await getDocs(collection(db,"users"));
    let isAdmin = false;
    snap.forEach(d=>{
        if(d.id === uid && d.data().role === "admin") isAdmin = true;
    });

    if(!isAdmin){
        alert("Access denied. Admin only.");
        location.href = "login.html";
        return;
    }

    // load users for table
    loadUsers();
});

/* CREATE RECRUITER */
async function createRecruiter(){
    let nameVal  = document.getElementById("newFullName").value.trim();
    let email = document.getElementById("newEmail").value.trim();
    let pass  = document.getElementById("newPassword").value.trim();

    if(!email || !pass){
        alert("Enter email & password");
        return;
    }

    try{
        // create in Auth
        let res = await createUserWithEmailAndPassword(auth, email, pass);
        let uid = res.user.uid;

        // write Firestore user doc with fullName (optional)
        await setDoc(doc(db,"users",uid),{
            email: email,
            empID: email.split("@")[0],
            role: "recruiter",
            fullName: nameVal || ""   // new name field
        });

        alert("Recruiter Created");
        document.getElementById("newEmail").value = "";
        document.getElementById("newPassword").value = "";
        document.getElementById("newFullName").value = "";
        loadUsers();

    }catch(e){
        alert("Error: " + e.message);
    }
}

/* LOAD USERS */
async function loadUsers(){
    let snap = await getDocs(collection(db,"users"));
    userBody.innerHTML = "";

    snap.forEach(u=>{
        let d = u.data();
        const full = d.fullName || "";
        userBody.innerHTML += `
        <tr>
            <td>${d.empID}</td>
            <td id="name_${u.id}">${full}</td>
            <td>${d.email}</td>
            <td>${d.role}</td>
            <td>${u.id}</td>

            <td>
                <button class="blueBtn" onclick="resetPass('${d.email}')">
                    Reset
                </button>
            </td>

            <td>
                <button class="greyBtn" onclick="editNamePrompt('${u.id}', '${escapeHtml(full)}')">Edit</button>
            </td>

            <td>
                <button class="redBtn" onclick="deleteUserRecord('${u.id}')">
                    Delete
                </button>
            </td>
        </tr>`;
    });
}

/* RESET PASSWORD */
async function resetPass(email){
    await sendPasswordResetEmail(auth, email);
    alert("Reset link sent to " + email);
}

/* EDIT NAME (prompt) */
async function editNamePrompt(uid, currentName){
    // unescape currentName for prompt
    const cur = currentName || "";
    const newName = prompt("Enter full name for this user:", cur);
    if(newName === null) return; // cancelled
    const ref = doc(db,"users",uid);
    try{
        await updateDoc(ref, { fullName: newName.trim() });
        // update UI cell
        const cell = document.getElementById(`name_${uid}`);
        if(cell) cell.textContent = newName.trim();
        alert("Name updated");
    }catch(err){
        alert("Error updating name: " + err.message);
    }
}

/* DELETE USER */
async function deleteUserRecord(uid){
    if(!confirm("Delete this user? This will remove their Firestore record (Auth user may still exist).")) return;

    try{
        await deleteDoc(doc(db,"users",uid));
        alert("Deleted user record from Firestore");
        loadUsers();

    }catch(err){
        alert("Error: " + err.message);
    }
}

/* UTIL: escapeHtml for inline injection safety */
function escapeHtml(s){
    if(!s) return "";
    return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
}

/* BUTTONS */
function goBack(){
    location.href = "admin.html";
}

function toggleTheme(){
    document.body.classList.toggle("light");
}

function logout(){
    // mark logout time so next login shows full-screen welcome
    try{ localStorage.setItem("recruita_lastLogout", Date.now().toString()); }catch(e){}
    auth.signOut();
    location.href = "login.html";
}

// expose functions
window.createRecruiter = createRecruiter;
window.resetPass = resetPass;
window.deleteUserRecord = deleteUserRecord;
window.loadUsers = loadUsers;
window.editNamePrompt = editNamePrompt;
window.toggleTheme = toggleTheme;
window.logout = logout;
window.goBack = goBack;

</script>

</body>
</html>
