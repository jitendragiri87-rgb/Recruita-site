<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Recruiter Panel</title>

<style>
body{
  background:#0b0b0c;color:white;font-family:Inter;padding:20px;
}
h2{margin-top:25px;margin-bottom:10px;}
input, select{
  width:100%;padding:12px;border-radius:8px;border:none;margin-top:10px;
  background:#1a1a1a;color:white;
}
button{
  width:100%;padding:14px;background:#2B7FFF;border:none;border-radius:10px;
  margin-top:20px;font-size:17px;color:white;font-weight:600;
  transition:0.2s;
}
button:active{
  transform:scale(0.97);
  background:#1f63cc;
}
.container{
  max-width:1000px;margin:auto;
}
.tableWrap{
  background:#111;padding:16px;border-radius:12px;margin-top:20px;overflow-x:auto;
}
table{
  width:100%;border-collapse:collapse;margin-top:10px;font-size:14px;
}
th,td{
  border:1px solid #333;padding:10px;text-align:left;
}
th{
  background:#1d1d1d;color:#2B7FFF;font-weight:700;
}
.filterBox{
  background:#111;padding:16px;border-radius:12px;margin-top:20px;
}
</style>
</head>

<body>

<div class="container">

<!-- ===================== DASHBOARD ======================= -->
<h2>Your Dashboard</h2>
<div class="tableWrap">
  <table>
    <thead>
      <tr>
        <th>EmpID</th>
        <th>Today's Count</th>
        <th>All-Time Count</th>
      </tr>
    </thead>
    <tbody id="dashBody"></tbody>
  </table>
</div>

<!-- ===================== ENTRY FORM ======================= -->
<h2>Add Candidate Entry</h2>

<input id="name" placeholder="Candidate Name">
<input id="number" placeholder="Candidate Number (10 digits)">
<input id="age" placeholder="Age">
<input id="experienceYears" placeholder="Total Experience (Years)">
<input id="loc" placeholder="Location">
<input id="ctc" placeholder="Current CTC">
<input id="comp" placeholder="Current Company">

<select id="channel">
  <option value="">Select Channel</option>
  <option>Banca</option>
  <option>Agency</option>
  <option>Direct</option>
  <option>Tele calling</option>
</select>

<input id="remarks" placeholder="Remarks">

<button id="submitBtn" onclick="saveData()">Submit Entry</button>

<!-- ===================== FILTERS ======================= -->
<h2>Filters</h2>
<div class="filterBox">

<input id="filterName" placeholder="Filter by Name">
<input id="filterNumber" placeholder="Filter by Number">
<input id="filterCompany" placeholder="Filter by Company">
<input id="filterRemark" placeholder="Filter by Remark">

<select id="filterChannel">
  <option value="">Filter by Channel</option>
  <option>Banca</option>
  <option>Agency</option>
  <option>Direct</option>
  <option>Tele calling</option>
</select>

<select id="filterLocation">
  <option value="">Filter by Location</option>
</select>

<input id="minAge" placeholder="Min Age">
<input id="maxAge" placeholder="Max Age">

<input id="minCTC" placeholder="Min CTC">
<input id="maxCTC" placeholder="Max CTC">

<input id="dateStart" type="date">
<input id="dateEnd" type="date">

<button onclick="applyFilters()">Apply Filters</button>
<button onclick="resetFilters()">Reset</button>

</div>

<!-- ===================== ENTRIES TABLE ======================= -->
<h2>Your Entries</h2>

<div class="tableWrap">
  <table>
    <thead>
      <tr>
        <th>Timestamp</th>
        <th>Name</th>
        <th>Number</th>
        <th>Age</th>
        <th>Experience Years</th>
        <th>Location</th>
        <th>CTC</th>
        <th>Company</th>
        <th>Channel</th>
        <th>Remarks</th>
      </tr>
    </thead>
    <tbody id="logs"></tbody>
  </table>
</div>

</div>


<script type="module">
import { auth, db } from "./firebase.js";
import {
  addDoc, collection, query, where, onSnapshot, doc, getDoc
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

let all = [];
let empID = localStorage.getItem("empID");

// ===================== SAVE ENTRY =======================
async function saveData(){

  if(!number.value || number.value.length !== 10){
    alert("Enter 10 digit valid number");
    return;
  }

  let btn = document.getElementById("submitBtn");
  btn.innerText = "Saving...";
  btn.disabled = true;

  await addDoc(collection(db,"callLogs"),{
    loginID: empID,
    ts: new Date().toISOString(),
    name: name.value || "",
    number: number.value,
    age: age.value || "",
    experienceYears: experienceYears.value || "",
    loc: loc.value || "",
    ctc: ctc.value || "",
    comp: comp.value || "",
    channel: channel.value || "",
    remarks: remarks.value || ""
  });

  // Clear fields
  name.value = "";
  number.value = "";
  age.value = "";
  experienceYears.value = "";
  loc.value = "";
  ctc.value = "";
  comp.value = "";
  channel.value = "";
  remarks.value = "";

  btn.innerText = "Submit Entry";
  btn.disabled = false;

  alert("Entry Saved");
}

// ===================== FETCH ONLY OWN ENTRIES =======================
const q = query(collection(db,"callLogs"), where("loginID","==",empID));

onSnapshot(q,(snap)=>{
  all = [];
  snap.forEach(doc => all.push(doc.data()));
  fillAuto();
  renderTable(all);
  buildDashboard();
});

// ===================== DASHBOARD =======================
function buildDashboard(){
  let today = new Date().toISOString().slice(0,10);

  let todayCount = all.filter(e=>e.ts.slice(0,10) === today).length;
  let totalCount = all.length;

  document.getElementById("dashBody").innerHTML = `
    <tr>
      <td>${empID}</td>
      <td>${todayCount}</td>
      <td>${totalCount}</td>
    </tr>
  `;
}

// ===================== AUTO FILTERS =======================
function fillAuto(){
  let locations = [...new Set(all.map(e=>e.loc).filter(e=>e))];

  filterLocation.innerHTML = `<option value="">Filter by Location</option>`;
  locations.forEach(l=> filterLocation.innerHTML += `<option>${l}</option>`);
}

// ===================== FILTER APPLY =======================
function applyFilters(){
  let data = all;

  if(filterName.value)
    data = data.filter(d => d.name.toLowerCase().includes(filterName.value.toLowerCase()));

  if(filterNumber.value)
    data = data.filter(d => d.number.includes(filterNumber.value));

  if(filterCompany.value)
    data = data.filter(d => d.comp.toLowerCase().includes(filterCompany.value.toLowerCase()));

  if(filterRemark.value)
    data = data.filter(d => d.remarks.toLowerCase().includes(filterRemark.value.toLowerCase()));

  if(filterChannel.value)
    data = data.filter(d => d.channel === filterChannel.value);

  if(filterLocation.value)
    data = data.filter(d => d.loc === filterLocation.value);

  if(minAge.value)
    data = data.filter(d => Number(d.age) >= Number(minAge.value));

  if(maxAge.value)
    data = data.filter(d => Number(d.age) <= Number(maxAge.value));

  if(minCTC.value)
    data = data.filter(d => Number(d.ctc) >= Number(minCTC.value));

  if(maxCTC.value)
    data = data.filter(d => Number(d.ctc) <= Number(maxCTC.value));

  if(dateStart.value)
    data = data.filter(d => new Date(d.ts) >= new Date(dateStart.value));

  if(dateEnd.value)
    data = data.filter(d => new Date(d.ts) <= new Date(dateEnd.value));

  renderTable(data);
}

function resetFilters(){
  filterName.value="";
  filterNumber.value="";
  filterCompany.value="";
  filterRemark.value="";
  filterChannel.value="";
  filterLocation.value="";
  minAge.value="";
  maxAge.value="";
  minCTC.value="";
  maxCTC.value="";
  dateStart.value="";
  dateEnd.value="";

  renderTable(all);
}

// ===================== RENDER TABLE =======================
function renderTable(list){
  let logs = document.getElementById("logs");
  logs.innerHTML = "";

  list.forEach(d=>{
    logs.innerHTML += `
      <tr>
        <td>${new Date(d.ts).toLocaleString()}</td>
        <td>${d.name}</td>
        <td>${d.number}</td>
        <td>${d.age}</td>
        <td>${d.experienceYears}</td>
        <td>${d.loc}</td>
        <td>${d.ctc}</td>
        <td>${d.comp}</td>
        <td>${d.channel}</td>
        <td>${d.remarks}</td>
      </tr>
    `;
  });
}

</script>

</body>
</html>
