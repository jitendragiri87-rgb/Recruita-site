<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Recruiter Panel</title>

<style>
body {
    background:#0b0b0c;
    color:white;
    font-family:Inter,sans-serif;
    padding:20px;
}
.light { background:#f2f2f2; color:#222; }

.topBar {
    display:flex;
    justify-content:flex-end;
    gap:10px;
    margin-bottom:18px;
}

button {
    padding:10px 18px;
    border:none;
    border-radius:6px;
    cursor:pointer;
    font-weight:600;
}
.blueBtn { background:#2B7FFF; color:white; }
.redBtn { background:#e74c3c; color:white; }
.greyBtn { background:#555; color:white; }

input, select {
    width:100%;
    padding:12px;
    margin-top:8px;
    background:#111;
    color:white;
    border:none;
    border-radius:8px;
}
.light input, .light select { background:white; color:black; border:1px solid #ccc; }

table {
    width:100%;
    border-collapse:collapse;
    margin-top:15px;
}
th, td {
    border:1px solid #333;
    padding:10px;
}
.light th, .light td { border:1px solid #ccc; }

.tableBox { overflow-x:auto; }

</style>
</head>

<body>

<div class="topBar">
    <button onclick="toggleTheme()" class="greyBtn">ðŸŒ“ Theme</button>
    <button onclick="logout()" class="redBtn">Logout</button>
</div>

<h2>Your Performance</h2>

<div class="tableBox">
<table>
    <thead>
        <tr>
            <th>EmpID</th>
            <th>Today's Count</th>
            <th>All-Time</th>
        </tr>
    </thead>
    <tbody id="dashBody"></tbody>
</table>
</div>

<h2>Add Candidate Entry</h2>

<input id="nameInput" placeholder="Name">
<input id="numberInput" placeholder="Number (10 digits)">
<input id="ageInput" placeholder="Age">
<input id="expInput" placeholder="Total Experience">
<input id="locInput" placeholder="Location">
<input id="ctcInput" placeholder="CTC">
<input id="compInput" placeholder="Current Company">

<select id="channelInput">
    <option value="">Select Channel</option>
    <option>Banca</option>
    <option>Agency</option>
    <option>Direct</option>
    <option>Tele calling</option>
</select>

<input id="remarkInput" placeholder="Remarks">

<button class="blueBtn" onclick="saveData()">Submit Entry</button>

<h2>Filters</h2>

<input id="filterName" placeholder="Filter by Name">
<input id="filterNumber" placeholder="Filter by Number">
<input id="filterCompany" placeholder="Filter by Company">
<input id="filterRemark" placeholder="Filter by Remark">

<select id="filterChannel">
    <option value="">Filter by Channel</option>
    <option>Banca</option>
    <option>Agency</option>
    <option>Direct</option>
    <option>Tele calling</option>
</select>

<select id="filterLocation">
    <option value="">Filter by Location</option>
</select>

<input id="minAge" placeholder="Min Age">
<input id="maxAge" placeholder="Max Age">

<input id="minCTC" placeholder="Min CTC">
<input id="maxCTC" placeholder="Max CTC">

<input id="dateStart" type="date">
<input id="dateEnd" type="date">

<button class="greyBtn" onclick="applyFilters()">Apply Filters</button>
<button class="greyBtn" onclick="resetFilters()">Reset</button>

<h2>Your Entries</h2>
<button class="greyBtn" onclick="exportCSV()">Download CSV</button>

<div class="tableBox">
<table>
    <thead>
        <tr>
            <th>Time</th>
            <th>Name</th>
            <th>Number</th>
            <th>Age</th>
            <th>Experience</th>
            <th>Location</th>
            <th>CTC</th>
            <th>Company</th>
            <th>Channel</th>
            <th>Remarks</th>
        </tr>
    </thead>
    <tbody id="listBody"></tbody>
</table>
</div>

<script type="module">
import { auth, db } from "./firebase.js";
import {
  collection, query, where, onSnapshot, addDoc
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

let empID = "";
let email = "";
let uid = "";
let all = [];

// Timestamp formatter
function formatTS(d){
    const p = n => n.toString().padStart(2,"0");
    return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;
}

// Auth check
auth.onAuthStateChanged(async user=>{
    if(!user) location.href="login.html";

    uid = user.uid;
    email = user.email;

    // load empID
    const ref = collection(db,"users");
    const q = query(ref, where("email","==", email));

    onSnapshot(q, snap=>{
        snap.forEach(d => empID = d.data().empID);
        loadData();
    });
});

// Load only own entries
function loadData(){
    const q = query(collection(db,"callLogs"), where("empID","==", empID));
    onSnapshot(q, snap=>{
        all = [];
        snap.forEach(d => all.push({ id:d.id, ...d.data() }));
        fillFilters();
        renderTable(all);
        renderDashboard();
    });
}

// Dashboard
function renderDashboard(){
    let today = new Date().toDateString();
    let t = all.filter(e => new Date(e.ts).toDateString() === today).length;
    let total = all.length;

    dashBody.innerHTML = `
        <tr>
            <td>${empID}</td>
            <td>${t}</td>
            <td>${total}</td>
        </tr>
    `;
}

// Save entry with duplicate check
async function saveData(){
    let num = numberInput.value.trim();
    if(num.length !== 10){
        alert("Enter valid 10-digit number");
        return;
    }

    let duplicate = all.find(e => e.number === num);

    if(duplicate){
        let ok = confirm("This number already exists in your entries. Do you still want to add?");
        if(!ok) return;
    }

    await addDoc(collection(db,"callLogs"),{
        ts: formatTS(new Date()),
        uid,
        empID,
        email,
        name: nameInput.value || "",
        number: num,
        age: ageInput.value || "",
        exp: expInput.value || "",
        loc: locInput.value || "",
        ctc: ctcInput.value || "",
        comp: compInput.value || "",
        channel: channelInput.value || "",
        remarks: remarkInput.value || ""
    });

    nameInput.value="";
    numberInput.value="";
    ageInput.value="";
    expInput.value="";
    locInput.value="";
    ctcInput.value="";
    compInput.value="";
    channelInput.value="";
    remarkInput.value="";

    alert("Entry Saved");
}

// Fill location dropdown
function fillFilters(){
    let locs = [...new Set(all.map(e => e.loc).filter(x => x))];
    filterLocation.innerHTML = `<option value="">Filter by Location</option>`;
    locs.forEach(l => filterLocation.innerHTML += `<option>${l}</option>`);
}

// Apply Filters
function applyFilters(){
    let data = all;

    if(filterName.value)
        data = data.filter(d => d.name.toLowerCase().includes(filterName.value.toLowerCase()));

    if(filterNumber.value)
        data = data.filter(d => d.number.includes(filterNumber.value));

    if(filterCompany.value)
        data = data.filter(d => d.comp.toLowerCase().includes(filterCompany.value.toLowerCase()));

    if(filterRemark.value)
        data = data.filter(d => d.remarks.toLowerCase().includes(filterRemark.value.toLowerCase()));

    if(filterChannel.value)
        data = data.filter(d => d.channel === filterChannel.value);

    if(filterLocation.value)
        data = data.filter(d => d.loc === filterLocation.value);

    if(minAge.value)
        data = data.filter(d => Number(d.age) >= Number(minAge.value));

    if(maxAge.value)
        data = data.filter(d => Number(d.age) <= Number(maxAge.value));

    if(minCTC.value)
        data = data.filter(d => Number(d.ctc) >= Number(minCTC.value));

    if(maxCTC.value)
        data = data.filter(d => Number(d.ctc) <= Number(maxCTC.value));

    if(dateStart.value)
        data = data.filter(d => new Date(d.ts) >= new Date(dateStart.value));

    if(dateEnd.value)
        data = data.filter(d => new Date(d.ts) <= new Date(dateEnd.value));

    renderTable(data);
}

// Reset Filters
function resetFilters(){
    filterName.value="";
    filterNumber.value="";
    filterCompany.value="";
    filterRemark.value="";
    filterChannel.value="";
    filterLocation.value="";
    minAge.value="";
    maxAge.value="";
    minCTC.value="";
    maxCTC.value="";
    dateStart.value="";
    dateEnd.value="";
    renderTable(all);
}

// Render table
function renderTable(list){
    listBody.innerHTML = "";

    list.forEach(d=>{
        listBody.innerHTML += `
        <tr>
            <td>${d.ts}</td>
            <td>${d.name}</td>
            <td>${d.number}</td>
            <td>${d.age}</td>
            <td>${d.exp}</td>
            <td>${d.loc}</td>
            <td>${d.ctc}</td>
            <td>${d.comp}</td>
            <td>${d.channel}</td>
            <td>${d.remarks}</td>
        </tr>
        `;
    });
}

// CSV Export
function exportCSV(){
    let csv = "Time,Name,Number,Age,Experience,Location,CTC,Company,Channel,Remarks\n";

    all.forEach(d=>{
        csv += `${d.ts},${d.name},${d.number},${d.age},${d.exp},${d.loc},${d.ctc},${d.comp},${d.channel},${d.remarks}\n`;
    });

    let a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([csv], {type:"text/csv"}));
    a.download = `${empID}_Recruiter_Data.csv`;
    a.click();
}

// Logout
function logout(){
    auth.signOut();
    location.href="login.html";
}

// Theme Toggle
function toggleTheme(){
    document.body.classList.toggle("light");
}

// Expose globals
window.applyFilters = applyFilters;
window.resetFilters = resetFilters;
window.saveData = saveData;
window.exportCSV = exportCSV;
window.logout = logout;
window.toggleTheme = toggleTheme;

</script>
</body>
</html>
