<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Recruiter Panel</title>

<style>
:root {
  --bg:#0b0b0c;
  --card:#111;
  --text:#fff;
  --text-light:#ccc;
  --btn:#2B7FFF;
  --table-border:#444;
}

.light {
  --bg:#f5f5f5;
  --card:#fff;
  --text:#000;
  --text-light:#444;
  --btn:#0066ff;
  --table-border:#ddd;
}

body{
  background:var(--bg);
  color:var(--text);
  font-family:Inter, sans-serif;
  padding:20px;
}

.container{
  max-width:1100px;
  margin:auto;
}

h2{
  margin-top:25px;
  margin-bottom:12px;
}

input, select{
  width:100%;
  padding:12px;
  border-radius:8px;
  border:none;
  margin-top:10px;
  background:#1a1a1a;
  color:white;
}

button{
  padding:12px 20px;
  background:var(--btn);
  border:none;
  border-radius:8px;
  margin-top:16px;
  font-weight:600;
  color:white;
  cursor:pointer;
}

button:active{
  transform:scale(0.97);
}

.tableBox{
  overflow-x:auto;
  margin-top:20px;
}

table{
  width:100%;
  border-collapse:collapse;
}

th, td{
  border:1px solid var(--table-border);
  padding:10px;
  text-align:left;
}

th{
  background:var(--card);
  color:var(--btn);
}

.topBar{
  display:flex;
  justify-content:flex-end;
  gap:10px;
  margin-bottom:20px;
}

.filterBox{
  background:var(--card);
  padding:16px;
  border-radius:12px;
  margin-top:20px;
}
</style>

</head>
<body>

<div class="container">

<!-- TOP BUTTONS -->
<div class="topBar">
  <button id="themeBtn">ðŸŒ“ Theme</button>
  <button id="logoutBtn">Logout</button>
</div>

<!-- DASHBOARD -->
<h2>Your Performance</h2>
<div class="tableBox">
  <table>
    <thead>
      <tr>
        <th>EmpID</th>
        <th>Today's Count</th>
        <th>All-Time Count</th>
      </tr>
    </thead>
    <tbody id="dashBody"></tbody>
  </table>
</div>

<!-- ENTRY FORM -->
<h2>Add Candidate Entry</h2>

<input id="name" placeholder="Candidate Name">
<input id="number" placeholder="Candidate Number (10 digits)">
<input id="age" placeholder="Age">
<input id="expYears" placeholder="Total Experience (Years)">
<input id="loc" placeholder="Location">
<input id="ctc" placeholder="Current CTC">
<input id="comp" placeholder="Current Company">

<select id="channel">
  <option value="">Select Channel</option>
  <option>Banca</option>
  <option>Agency</option>
  <option>Direct</option>
  <option>Tele calling</option>
</select>

<input id="remarks" placeholder="Remarks">

<button id="saveBtn">Submit Entry</button>

<!-- FILTERS -->
<h2>Filters</h2>
<div class="filterBox">

<input id="filterName" placeholder="Filter by Name">
<input id="filterNumber" placeholder="Filter by Number">
<input id="filterCompany" placeholder="Filter by Company">
<input id="filterRemark" placeholder="Filter by Remark">

<select id="filterChannel">
  <option value="">Filter by Channel</option>
  <option>Banca</option>
  <option>Agency</option>
  <option>Direct</option>
  <option>Tele calling</option>
</select>

<select id="filterLocation">
  <option value="">Filter by Location</option>
</select>

<input id="minAge" placeholder="Min Age">
<input id="maxAge" placeholder="Max Age">

<input id="minCTC" placeholder="Min CTC">
<input id="maxCTC" placeholder="Max CTC">

<input id="dateStart" type="date">
<input id="dateEnd" type="date">

<button onclick="applyFilters()">Apply Filters</button>
<button onclick="resetFilters()">Reset</button>
</div>

<!-- TABLE -->
<h2>Your Entries</h2>
<button id="csvBtn">Download CSV (Only Your Data)</button>

<div class="tableBox">
  <table id="entryTable">
    <thead>
      <tr>
        <th>Timestamp</th>
        <th>Name</th>
        <th>Number</th>
        <th>Age</th>
        <th>Experience</th>
        <th>Location</th>
        <th>CTC</th>
        <th>Company</th>
        <th>Channel</th>
        <th>Remarks</th>
      </tr>
    </thead>
    <tbody id="dataBody"></tbody>
  </table>
</div>

</div>

<script type="module">
import { auth, db, getUserInfo } from "./firebase.js";
import {
  collection, query, where, addDoc, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

let empID = "";
let email = "";
let uid = "";
let ALL = [];

// AUTH CHECK
auth.onAuthStateChanged(async user=>{
  if(!user) location.href="login.html";

  const info = await getUserInfo();
  if(!info || info.role!=="recruiter") location.href="login.html";

  empID = info.empID;
  email = info.email;
  uid = info.uid;

  loadData();
});

// LOAD OWN DATA ONLY
function loadData(){
  const q = query(collection(db,"callLogs"), where("empID","==",empID));

  onSnapshot(q, snap=>{
    ALL = [];
    snap.forEach(d=> ALL.push(d.data()));
    buildDashboard();
    fillFilters();
    render(ALL);
  });
}

// DASHBOARD
function buildDashboard(){
  let today = new Date().toISOString().slice(0,10);

  let todayCount = ALL.filter(e=>e.ts.slice(0,10)==today).length;
  let totalCount = ALL.length;

  dashBody.innerHTML = `
    <tr>
      <td>${empID}</td>
      <td>${todayCount}</td>
      <td>${totalCount}</td>
    </tr>
  `;
}

// SAVE ENTRY
document.getElementById("saveBtn").onclick = async()=>{

  let num = number.value.trim();
  if(num.length!==10){
    alert("10 digit number required");
    return;
  }

  // Duplicate check only if same recruiter already entered
  let duplicate = ALL.find(e=> e.number===num);
  if(duplicate){
    let ok = confirm("Duplicate entry found for this number. Still want to add?");
    if(!ok) return;
  }

  await addDoc(collection(db,"callLogs"),{
    ts:new Date().toISOString(),
    uid,
    email,
    empID,
    name:name.value,
    number:num,
    age:age.value || "",
    expYears:expYears.value || "",
    loc:loc.value || "",
    ctc:ctc.value || "",
    comp:comp.value || "",
    channel:channel.value || "",
    remarks:remarks.value || ""
  });

  alert("Entry Saved");

  name.value = number.value = age.value = expYears.value = loc.value =
  ctc.value = comp.value = channel.value = remarks.value = "";
};

// FILTERS
function fillFilters(){
  let locs = [...new Set(ALL.map(e=>e.loc).filter(x=>x))];
  filterLocation.innerHTML = `<option value="">Filter by Location</option>`;
  locs.forEach(l=> filterLocation.innerHTML += `<option>${l}</option>`);
}

function applyFilters(){
  let data = ALL;

  if(filterName.value)
    data = data.filter(d=> d.name.toLowerCase().includes(filterName.value.toLowerCase()));

  if(filterNumber.value)
    data = data.filter(d=> d.number.includes(filterNumber.value));

  if(filterCompany.value)
    data = data.filter(d=> d.comp.toLowerCase().includes(filterCompany.value.toLowerCase()));

  if(filterRemark.value)
    data = data.filter(d=> d.remarks.toLowerCase().includes(filterRemark.value.toLowerCase()));

  if(filterChannel.value)
    data = data.filter(d=> d.channel===filterChannel.value);

  if(filterLocation.value)
    data = data.filter(d=> d.loc===filterLocation.value);

  if(minAge.value)
    data = data.filter(d=> Number(d.age)>=Number(minAge.value));

  if(maxAge.value)
    data = data.filter(d=> Number(d.age)<=Number(maxAge.value));

  if(minCTC.value)
    data = data.filter(d=> Number(d.ctc)>=Number(minCTC.value));

  if(maxCTC.value)
    data = data.filter(d=> Number(d.ctc)<=Number(maxCTC.value));

  if(dateStart.value)
    data = data.filter(d=> new Date(d.ts)>=new Date(dateStart.value));

  if(dateEnd.value)
    data = data.filter(d=> new Date(d.ts)<=new Date(dateEnd.value));

  render(data);
}

function resetFilters(){
  filterName.value="";
  filterNumber.value="";
  filterCompany.value="";
  filterRemark.value="";
  filterChannel.value="";
  filterLocation.value="";
  minAge.value="";
  maxAge.value="";
  minCTC.value="";
  maxCTC.value="";
  dateStart.value="";
  dateEnd.value="";
  render(ALL);
}

// RENDER TABLE
function render(list){
  dataBody.innerHTML = "";
  list.forEach(d=>{
    dataBody.innerHTML += `
      <tr>
        <td>${new Date(d.ts).toLocaleString()}</td>
        <td>${d.name}</td>
        <td>${d.number}</td>
        <td>${d.age}</td>
        <td>${d.expYears}</td>
        <td>${d.loc}</td>
        <td>${d.ctc}</td>
        <td>${d.comp}</td>
        <td>${d.channel}</td>
        <td>${d.remarks}</td>
      </tr>
    `;
  });
}

// CSV EXPORT
csvBtn.onclick = ()=>{
  let csv = "Timestamp,Name,Number,Age,ExpYears,Location,CTC,Company,Channel,Remarks\n";

  ALL.forEach(e=>{
    csv += `${e.ts},${e.name},${e.number},${e.age},${e.expYears},${e.loc},${e.ctc},${e.comp},${e.channel},${e.remarks}\n`;
  });

  let blob = new Blob([csv],{type:"text/csv"});
  let a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `${empID}_Recruiter_Data.csv`;
  a.click();
};

// THEME MODE
let theme = localStorage.getItem("theme") || "dark";
applyTheme(theme);

document.getElementById("themeBtn").onclick = ()=>{
  theme = theme==="dark" ? "light" : "dark";
  applyTheme(theme);
};

function applyTheme(t){
  if(t==="light") document.body.classList.add("light");
  else document.body.classList.remove("light");
  localStorage.setItem("theme",t);
}

// LOGOUT
logoutBtn.onclick = ()=>{
  auth.signOut();
};

</script>

</body>
</html>
