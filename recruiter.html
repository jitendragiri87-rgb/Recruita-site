/* Firestore auth + load user doc. Ensure welcome is shown reliably */
auth.onAuthStateChanged(async user => {
  if(!user){ location.href='login.html'; return; }
  uid = user.uid; email = user.email;

  // Wait for the user's doc to load (or timeout) before registering callLogs listener.
  const ref = collection(db,'users');
  const q = query(ref, where('email','==', email));

  let docLoaded = false;
  const waitForDoc = new Promise((resolve) => {
    // subscribe once, then unsubscribe to grab the doc
    const unsub = onSnapshot(q, snap => {
      snap.forEach(d => {
        const data = d.data() || {};
        empID = data.empID || (email ? email.split('@')[0] : 'User');
        displayName = (data.fullName || data.name || empID || (email ? email.split('@')[0] : 'there')).trim();
        docLoaded = true;
      });
      resolve();
      unsub();
    }, err => {
      console.warn('user doc snapshot error', err);
      resolve();
      unsub();
    });
  });

  // Wait for the user doc or timeout (900ms) — whichever first.
  const timeout = new Promise(r => setTimeout(r, 900));
  await Promise.race([waitForDoc, timeout]);

  // Now we have empID (or fallback); start listening to callLogs filtered by empID
  loadData(empID);

  // Ensure welcome shows — if doc arrived, normal logic; otherwise force show so user sees something
  handleWelcomeLogic(!docLoaded);
});
