<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Recruiter Panel</title>

<!-- TABULATOR EXCEL TABLE -->
<link href="https://unpkg.com/tabulator-tables@6.2.1/dist/css/tabulator_midnight.min.css" rel="stylesheet">
<script src="https://unpkg.com/tabulator-tables@6.2.1/dist/js/tabulator.min.js"></script>

<style>
body{
    background:#0b0b0c;
    color:white;
    font-family:Inter,sans-serif;
    padding:20px;
    transition:0.3s;
}
body.light{
    background:#f2f2f2;
    color:#111;
}

.topBar{
    display:flex;
    justify-content:flex-end;
    gap:10px;
    margin-bottom:20px;
}

button{
    padding:10px 18px;
    border:none;
    border-radius:6px;
    font-weight:600;
    cursor:pointer;
}
.blueBtn{ background:#2B7FFF; color:white; }
.greyBtn{ background:#555; color:white; }
.redBtn{ background:#e74c3c; color:white; }

input,select{
    width:100%;
    padding:12px;
    margin-top:8px;
    border:none;
    border-radius:8px;
    background:#111;
    color:white;
}
body.light input,body.light select{
    background:white;
    color:#222;
    border:1px solid #ccc;
}

#tableWrapper {
    overflow-x:auto;
    width:100%;
    margin-top:20px;
    border:1px solid #333;
}

.tabulator {
    background:#0b0b0c !important;
}
body.light .tabulator{
    background:#fff !important;
}

.tabulator-col-title, .tabulator-cell{
    white-space:nowrap;
}
</style>
</head>

<body>

<div class="topBar">
    <button onclick="toggleTheme()" class="greyBtn">ðŸŒ“ Theme</button>
    <button onclick="logout()" class="redBtn">Logout</button>
</div>

<h2>Your Performance</h2>
<table style="width:100%; border-collapse:collapse;">
<thead>
<tr>
<th style="border:1px solid #333; padding:10px;">EmpID</th>
<th style="border:1px solid #333; padding:10px;">Today</th>
<th style="border:1px solid #333; padding:10px;">Total</th>
</tr>
</thead>
<tbody id="dashBody"></tbody>
</table>

<h2>Add Candidate Entry</h2>

<input id="nameInput" placeholder="Name">
<input id="numberInput" placeholder="Number (10 digits)">
<input id="ageInput" placeholder="Age">
<input id="expInput" placeholder="Total Experience">
<input id="locInput" placeholder="Location">
<input id="ctcInput" placeholder="CTC">
<input id="compInput" placeholder="Current Company">

<select id="channelInput">
    <option value="">Select Channel</option>
    <option>Banca</option>
    <option>Agency</option>
    <option>Direct</option>
    <option>Tele calling</option>
    <option>Other</option>
</select>

<select id="statusInput">
    <option value="">Call Status</option>
    <option>Interested</option>
    <option>Not Interested</option>
    <option>Not Answered</option>
</select>

<input id="remarkInput" placeholder="Remarks">

<button class="blueBtn" onclick="saveData()">Submit Entry</button>
<button class="blueBtn" onclick="exportCSV()" style="margin-top:20px;">Download CSV</button>

<h2 style="margin-top:30px;">Your Entries</h2>

<!-- TABLE WRAPPER FOR SCROLL -->
<div id="tableWrapper">
    <div id="listTable"></div>
</div>

<script type="module">
import { auth, db } from "./firebase.js";
import {
  collection, query, where, onSnapshot, addDoc
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

let empID = "";
let uid = "";
let email = "";
let all = [];

function formatTS(d){
  const p=n=>n.toString().padStart(2,"0");
  return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;
}

auth.onAuthStateChanged(async user=>{
    if(!user) location.href="login.html";

    uid = user.uid;
    email = user.email;

    const ref = collection(db,"users");
    const q = query(ref, where("email","==", email));

    onSnapshot(q, snap=>{
        snap.forEach(d => empID = d.data().empID);
        loadData(empID);
    });
});

let table;

function loadData(empID){
    const q = query(collection(db,"callLogs"), where("empID","==", empID));

    onSnapshot(q, snap=>{
        all = [];
        snap.forEach(d => all.push({...d.data(), id:d.id}));

        // latest first
        all.sort((a,b)=> new Date(b.ts) - new Date(a.ts));

        renderDashboard();
        renderTable(all);
    });
}

function renderDashboard(){
    let today = new Date().toDateString();
    let countToday = all.filter(e => new Date(e.ts).toDateString() === today).length;

    dashBody.innerHTML = `
        <tr>
            <td style="border:1px solid #333; padding:10px;">${empID}</td>
            <td style="border:1px solid #333; padding:10px;">${countToday}</td>
            <td style="border:1px solid #333; padding:10px;">${all.length}</td>
        </tr>
    `;
}

async function saveData(){
    let num = numberInput.value.trim();
    if(num.length !== 10){
        alert("Enter valid 10-digit number");
        return;
    }

    await addDoc(collection(db,"callLogs"),{
        ts: formatTS(new Date()),
        uid,
        empID,
        email,
        name: nameInput.value,
        number: num,
        age: ageInput.value,
        exp: expInput.value,
        loc: locInput.value,
        ctc: ctcInput.value,
        comp: compInput.value,
        channel: channelInput.value,
        callStatus: statusInput.value,
        remarks: remarkInput.value
    });

    nameInput.value="";
    numberInput.value="";
    ageInput.value="";
    expInput.value="";
    locInput.value="";
    ctcInput.value="";
    compInput.value="";
    channelInput.value="";
    statusInput.value="";
    remarkInput.value="";

    alert("Entry Saved");
}

function renderTable(data){
    if(table){
        table.replaceData(data);
        return;
    }

    table = new Tabulator("#listTable", {
        data:data,
        layout:"fitDataFill",   // auto-fit columns
        responsiveLayout:false,
        height:"480px",
        movableColumns:true,
        pagination:false,
        columnDefaults:{ resizable:true },

        columns:[
            {title:"Call", field:"number",
                formatter:cell=>`<a href="tel:${cell.getValue()}" style="color:#2B7FFF;font-size:20px;">ðŸ“ž</a>`},

            {title:"Time â–¼", field:"ts", sorter:"datetime", headerFilter:"input"},
            {title:"Name â–¼", field:"name", sorter:"string", headerFilter:"input"},
            {title:"Number â–¼", field:"number", sorter:"number", headerFilter:"input"},
            {title:"Age â–¼", field:"age", sorter:"number", headerFilter:"input"},
            {title:"Experience â–¼", field:"exp", sorter:"number", headerFilter:"input"},
            {title:"Location â–¼", field:"loc", sorter:"string", headerFilter:"input"},
            {title:"CTC â–¼", field:"ctc", sorter:"number", headerFilter:"input"},
            {title:"Company â–¼", field:"comp", sorter:"string", headerFilter:"input"},
            {title:"Channel â–¼", field:"channel", sorter:"string", headerFilter:"input"},
            {title:"Status â–¼", field:"callStatus", sorter:"string", headerFilter:"input"},
            {title:"Remarks â–¼", field:"remarks", sorter:"string", headerFilter:"input"},
        ],
    });
}

function exportCSV(){
    table.download("csv", `${empID}_data.csv`);
}

function logout(){
    auth.signOut();
    location.href="login.html";
}

function toggleTheme(){
    document.body.classList.toggle("light");

    // Change Tabulator theme
    if(document.body.classList.contains("light")){
        document.querySelector(".tabulator").classList.remove("tabulator_midnight");
    } else {
        document.querySelector(".tabulator").classList.add("tabulator_midnight");
    }
}
</script>

</body>
</html>
