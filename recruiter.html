<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Recruiter Panel</title>

<!-- TABULATOR EXCEL TABLE -->
<link href="https://unpkg.com/tabulator-tables@6.2.1/dist/css/tabulator_midnight.min.css" rel="stylesheet">
<script src="https://unpkg.com/tabulator-tables@6.2.1/dist/js/tabulator.min.js"></script>

<style>
body{
    background:#0b0b0c;
    color:white;
    font-family:Inter,sans-serif;
    padding:20px;
    transition:0.3s;
}
body.light{
    background:#f2f2f2;
    color:#111;
}

.topBar{
    display:flex;
    justify-content:flex-end;
    gap:10px;
    margin-bottom:20px;
}

button{
    padding:10px 18px;
    border:none;
    border-radius:6px;
    font-weight:600;
    cursor:pointer;
}
.blueBtn{ background:#2B7FFF; color:white; }
.greyBtn{ background:#555; color:white; }
.redBtn{ background:#e74c3c; color:white; }

input,select{
    width:100%;
    padding:12px;
    margin-top:8px;
    border:none;
    border-radius:8px;
    background:#111;
    color:white;
}
body.light input,body.light select{
    background:white;
    color:#222;
    border:1px solid #ccc;
}

#tableWrapper {
    overflow-x:auto;
    width:100%;
    margin-top:20px;
    border:1px solid #333;
}

.tabulator {
    background:#0b0b0c !important;
}
body.light .tabulator{
    background:#fff !important;
}

.tabulator-col-title, .tabulator-cell{
    white-space:nowrap;
}
</style>
</head>

<body>

<div class="topBar">
    <button id="themeBtn" class="greyBtn">ðŸŒ“ Theme</button>
    <button id="logoutBtn" class="redBtn">Logout</button>
</div>

<h2>Your Performance</h2>
<table style="width:100%; border-collapse:collapse;">
<thead>
<tr>
<th style="border:1px solid #333; padding:10px;">EmpID</th>
<th style="border:1px solid #333; padding:10px;">Today</th>
<th style="border:1px solid #333; padding:10px;">Total</th>
</tr>
</thead>
<tbody id="dashBody"></tbody>
</table>

<h2>Add Candidate Entry</h2>

<input id="nameInput" placeholder="Name">
<input id="numberInput" placeholder="Number (10 digits)">
<input id="ageInput" placeholder="Age">
<input id="expInput" placeholder="Total Experience">
<input id="locInput" placeholder="Location">
<input id="ctcInput" placeholder="CTC">
<input id="compInput" placeholder="Current Company">

<select id="channelInput">
    <option value="">Select Channel</option>
    <option>Banca</option>
    <option>Agency</option>
    <option>Direct</option>
    <option>Tele calling</option>
    <option>Other</option>
</select>

<select id="statusInput">
    <option value="">Call Status</option>
    <option>Interested</option>
    <option>Not Interested</option>
    <option>Not Answered</option>
</select>

<input id="remarkInput" placeholder="Remarks">

<button id="saveBtn" class="blueBtn" style="margin-top:10px;">Submit Entry</button>
<button id="csvBtn" class="blueBtn" style="margin-top:10px;">Download CSV</button>

<h2 style="margin-top:30px;">Your Entries</h2>

<!-- TABLE WRAPPER FOR SCROLL -->
<div id="tableWrapper">
    <div id="listTable"></div>
</div>

<script type="module">
import { auth, db } from "./firebase.js";
import {
  collection, query, where, onSnapshot, addDoc
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

let empID = "";
let uid = "";
let email = "";
let all = [];
let table = null;

function formatTS(d){
  const p=n=>n.toString().padStart(2,"0");
  return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;
}

// Auth & load user-specific data
auth.onAuthStateChanged(async user=>{
    if(!user){
        location.href="login.html";
        return;
    }

    uid = user.uid;
    email = user.email;

    // find empID from users collection
    const ref = collection(db,"users");
    const q = query(ref, where("email","==", email));

    onSnapshot(q, snap=>{
        snap.forEach(d => empID = d.data().empID || "");
        // once empID is available, load entries
        if(empID) loadData(empID);
    });
});

function loadData(empID){
    const q = query(collection(db,"callLogs"), where("empID","==", empID));

    onSnapshot(q, snap=>{
        all = [];
        snap.forEach(d => all.push({...d.data(), id:d.id}));

        // sort latest first (ts stored as formatted string => convert)
        all.sort((a,b)=>{
            // fallback if ts missing
            let ta = a.ts ? new Date(a.ts) : new Date(0);
            let tb = b.ts ? new Date(b.ts) : new Date(0);
            return tb - ta;
        });

        renderDashboard();
        renderTable(all);
    });
}

function renderDashboard(){
    let today = new Date().toDateString();
    let countToday = all.filter(e => e.ts && new Date(e.ts).toDateString() === today).length;

    dashBody.innerHTML = `
        <tr>
            <td style="border:1px solid #333; padding:10px;">${empID}</td>
            <td style="border:1px solid #333; padding:10px;">${countToday}</td>
            <td style="border:1px solid #333; padding:10px;">${all.length}</td>
        </tr>
    `;
}

async function saveData(){
    let num = document.getElementById("numberInput").value.trim();
    if(num.length !== 10 || !/^\d{10}$/.test(num)){
        alert("Enter valid 10-digit number");
        return;
    }

    // duplicate check: only for this recruiter
    let dup = all.find(x => x.number === num && x.empID === empID);
    if(dup){
        if(!confirm("Duplicate number found in your entries. Still add?")) return;
    }

    await addDoc(collection(db,"callLogs"),{
        ts: formatTS(new Date()),
        uid,
        empID,
        email,
        name: document.getElementById("nameInput").value || "",
        number: num,
        age: document.getElementById("ageInput").value || "",
        exp: document.getElementById("expInput").value || "",
        loc: document.getElementById("locInput").value || "",
        ctc: document.getElementById("ctcInput").value || "",
        comp: document.getElementById("compInput").value || "",
        channel: document.getElementById("channelInput").value || "",
        callStatus: document.getElementById("statusInput").value || "",
        remarks: document.getElementById("remarkInput").value || ""
    });

    // reset inputs
    ["nameInput","numberInput","ageInput","expInput","locInput","ctcInput","compInput","channelInput","statusInput","remarkInput"]
      .forEach(id => document.getElementById(id).value = "");

    alert("Entry Saved");
}

function renderTable(data){
    // initialize Tabulator once
    if(table){
        table.setData(data);
        return;
    }

    table = new Tabulator("#listTable", {
        data:data,
        layout:"fitDataFill",
        responsiveLayout:false,
        height:"480px",
        movableColumns:true,
        pagination:false,
        columnDefaults:{ resizable:true },
        placeholder:"No entries yet",
        columns:[
            {title:"Call", field:"number", hozAlign:"center", formatter:cell=>`<a href="tel:${cell.getValue()}" style="color:#2B7FFF;font-size:18px;">ðŸ“ž</a>`},
            {title:"Time â–¼", field:"ts", sorter:"string", headerFilter:"input"},
            {title:"Name â–¼", field:"name", sorter:"string", headerFilter:"input"},
            {title:"Number â–¼", field:"number", sorter:"string", headerFilter:"input"},
            {title:"Age â–¼", field:"age", sorter:"number", headerFilter:"input"},
            {title:"Experience â–¼", field:"exp", sorter:"number", headerFilter:"input"},
            {title:"Location â–¼", field:"loc", sorter:"string", headerFilter:"input"},
            {title:"CTC â–¼", field:"ctc", sorter:"number", headerFilter:"input"},
            {title:"Company â–¼", field:"comp", sorter:"string", headerFilter:"input"},
            {title:"Channel â–¼", field:"channel", sorter:"string", headerFilter:"input"},
            {title:"Status â–¼", field:"callStatus", sorter:"string", headerFilter:"input"},
            {title:"Remarks â–¼", field:"remarks", sorter:"string", headerFilter:"input"},
        ],
    });

    // apply Tabulator theme class if dark
    const tEl = document.querySelector(".tabulator");
    if(tEl){
        tEl.classList.add("tabulator_midnight");
    }
}

function exportCSV(){
    if(!table){
        alert("No data to export");
        return;
    }
    // filename with empID
    let filename = (empID||"recruiter") + "_data.csv";
    table.download("csv", filename);
}

function logout(){
    auth.signOut();
    location.href="login.html";
}

function toggleTheme(){
    document.body.classList.toggle("light");

    // safely toggle Tabulator theme if exists
    const tEl = document.querySelector(".tabulator");
    if(tEl){
        if(document.body.classList.contains("light")){
            tEl.classList.remove("tabulator_midnight");
        } else {
            tEl.classList.add("tabulator_midnight");
        }
    }
}

// --- Hook up buttons (module scope -> put on DOM events instead of inline onclick) ---
document.getElementById("saveBtn").addEventListener("click", saveData);
document.getElementById("csvBtn").addEventListener("click", exportCSV);
document.getElementById("logoutBtn").addEventListener("click", logout);
document.getElementById("themeBtn").addEventListener("click", toggleTheme);

// Expose for console/debug if needed
window.saveData = saveData;
window.exportCSV = exportCSV;
window.logout = logout;
window.toggleTheme = toggleTheme;

</script>

</body>
</html>
