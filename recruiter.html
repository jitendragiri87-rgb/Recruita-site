<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Recruiter Panel â€” Recruita</title>

<link href="https://unpkg.com/tabulator-tables@6.2.1/dist/css/tabulator_midnight.min.css" rel="stylesheet">
<script src="https://unpkg.com/tabulator-tables@6.2.1/dist/js/tabulator.min.js"></script>

<style>
:root{ --blue:#2B7FFF; --blue-dark:#1f63cc; --bg-dark:#0b0b0c; }
html,body{ margin:0; padding:0; background:var(--bg-dark); color:#fff; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
body.light{ background:#f4f6f8; color:#111; }

.topBar{ display:flex; justify-content:flex-end; align-items:center; gap:10px; padding:18px 20px 0 20px; }
button{ padding:10px 16px; border:none; border-radius:6px; cursor:pointer; font-weight:600; }
.blueBtn{ background:var(--blue); color:#fff; }
.blueBtn:hover{ background:var(--blue-dark); }
.greyBtn{ background:#555; color:#fff; }
.redBtn{ background:#e74c3c; color:#fff; }

#nameBadge{ display:none; align-items:center; gap:10px; padding:8px 12px; border-radius:8px; background:var(--blue); color:#fff; font-weight:700; font-size:15px; cursor:pointer; user-select:none; box-shadow: 0 6px 18px rgba(43,127,255,0.12); transition: transform .12s ease, background .18s; }
#nameBadge:hover{ transform: translateY(-2px); background:var(--blue-dark); }
#nameBadge .badgeAvatar{ width:28px; height:28px; border-radius:999px; display:inline-grid; place-items:center; background: linear-gradient(135deg,#6fb1ff,var(--blue)); color:#fff; font-weight:700; font-size:13px; flex:0 0 auto; }

.container{ padding:12px 20px 40px 20px; max-width:1200px; margin:0 auto; }
h2{ margin:10px 0 6px; }
#tableWrapper { overflow-x:auto; width:100%; margin-top:12px; border:1px solid rgba(255,255,255,0.04); border-radius:6px; padding:8px; }
.tabulator{ background:var(--bg-dark) !important; }
input,select{ width:100%; padding:12px; margin-top:8px; border:none; border-radius:8px; background:#111; color:#fff; }
body.light input, body.light select{ background:#fff; color:#222; border:1px solid #ddd; }

#dupHint{ margin-top:6px; font-size:13px; color:rgba(255,255,255,0.75); }

#welcomeFull{ position:fixed; inset:0; z-index:99990; display:none; align-items:center; justify-content:center; background:linear-gradient(180deg, rgba(2,6,23,0.95), rgba(8,13,30,0.95)); transition: transform .55s cubic-bezier(.2,.9,.25,1), opacity .3s ease; }
.welcomeCard{ width:min(820px,94vw); border-radius:18px; padding:36px 34px; text-align:center; background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.06); box-shadow: 0 20px 60px rgba(0,0,0,0.6); transform-origin:center; }
.avatarBig{ width:100px; height:100px; border-radius:999px; margin:0 auto 12px; display:grid; place-items:center; font-size:36px; font-weight:800; color:#fff; background:linear-gradient(135deg,#6fb1ff,var(--blue)); box-shadow: 0 12px 30px rgba(43,127,255,0.12); }
.welcomeTitle{ font-size:30px; font-weight:800; margin:6px 0; }
.welcomeSub{ font-size:16px; color:rgba(255,255,255,0.88); margin-bottom:18px; }
#welcomeFull.minimize{ transform: translate(calc(50vw - 120px), calc(-42vh)) scale(.18); opacity:1; pointer-events:none; }
#welcomeFull.minimize .welcomeCard{ transform: scale(.98); opacity:.95; }

#cartoonBox{ position:fixed; right:130px; top:72px; z-index:100000; display:none; width:260px; padding:14px; background:#fff; color:#111; border-radius:12px; box-shadow:0 18px 50px rgba(0,0,0,0.35); font-weight:600; transform-origin:right top; animation:pop .32s ease; }
#cartoonBox::after{ content:""; position:absolute; right:18px; top:100%; width:0; height:0; border-left:10px solid transparent; border-right:10px solid transparent; border-top:12px solid #fff; }
@keyframes pop{ from{ transform: scale(.92); opacity:0 } to{ transform: scale(1); opacity:1 } }
#cartoonBox .greet{ font-size:15px; margin-bottom:6px; color:#0b0b0c; }
#cartoonBox .line{ font-size:13px; color:#444; font-weight:500; }

#dupModal{ position:fixed; inset:0; z-index:100005; display:none; align-items:center; justify-content:center; background: rgba(2,6,23,0.6); }
#dupCard{ width:520px; max-width:94vw; border-radius:12px; padding:18px; background:#0f1114; color:#fff; border:1px solid rgba(255,255,255,0.06); box-shadow: 0 24px 80px rgba(0,0,0,0.6); }
#dupCard h3{ margin:0 0 8px; }
.dupItem{ padding:10px; border-radius:8px; background:rgba(255,255,255,0.02); margin-bottom:8px; font-size:13px; }
.dupBtns{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }

#welcomeMini{ position:fixed; left:20px; top:20px; z-index:9999; display:flex; align-items:center; gap:14px; padding:14px 18px; border-radius:12px; background:rgba(11,11,12,0.9); border:1px solid rgba(255,255,255,0.04); transform: translateY(-6px); opacity:0; transition:opacity .32s, transform .32s; pointer-events:none; }
#welcomeMini.show{ opacity:1; transform: translateY(0); pointer-events:auto; }
#welcomeMini .title{ font-size:18px; font-weight:700; line-height:1; }
#welcomeMini .sub{ font-size:13px; color:rgba(255,255,255,0.85); margin-top:4px }

@media(max-width:800px){ #cartoonBox{ right:18px; width:220px; top:72px; } #welcomeFull.minimize{ transform: translate(calc(40vw - 60px), calc(-44vh)) scale(.2); } }
</style>
</head>
<body>

<div class="topBar">
  <div id="nameBadge" title="Open message">
    <div class="badgeAvatar" id="badgeAvatar">R</div>
    <div id="badgeText">Recruiter</div>
  </div>

  <button id="themeBtn" class="greyBtn" onclick="toggleTheme()">ðŸŒ“ Theme</button>
  <button class="redBtn" onclick="logout()">Logout</button>
</div>

<div class="container">
  <h2>Your Performance</h2>
  <div id="tableWrapper">
    <table style="width:100%; border-collapse:collapse;">
      <thead>
        <tr>
          <th style="border:1px solid rgba(255,255,255,0.06); padding:10px;">Name</th>
          <th style="border:1px solid rgba(255,255,255,0.06); padding:10px;">Today</th>
          <th style="border:1px solid rgba(255,255,255,0.06); padding:10px;">Total</th>
        </tr>
      </thead>
      <tbody id="dashBody"></tbody>
    </table>
  </div>

  <h2 style="margin-top:18px">Add Candidate Entry</h2>
  <input id="nameInput" placeholder="Name">

  <input id="numberInput" placeholder="Number (10 digits)">
  <div id="dupHint" aria-live="polite"></div>

  <input id="ageInput" placeholder="Age (numbers only)">
  <input id="expInput" placeholder="Total Experience (years)">
  <input id="ctcInput" placeholder="CTC (numbers only)">

  <input id="locInput" placeholder="Location">
  <input id="compInput" placeholder="Current Company">

  <select id="channelInput">
    <option value="">Select Channel</option>
    <option>Banca</option>
    <option>Agency</option>
    <option>Direct</option>
    <option>Tele calling</option>
    <option>Other</option>
  </select>
  <select id="statusInput">
    <option value="">Call Status</option>
    <option>Interested</option>
    <option>Not Interested</option>
    <option>Not Answered</option>
  </select>
  <input id="remarkInput" placeholder="Remarks">

  <div style="margin-top:12px;">
    <button id="submitBtn" class="blueBtn" onclick="saveData(event)">Submit Entry</button>
    <button class="blueBtn" onclick="exportCSV()" style="margin-left:10px;">Download CSV</button>
  </div>

  <h2 style="margin-top:30px;">Your Entries</h2>
  <div id="listTable" style="margin-top:12px"></div>
</div>

<div id="welcomeFull" aria-hidden="true" role="dialog">
  <div class="welcomeCard" aria-label="Welcome">
    <div class="avatarBig" id="fullAvatar">R</div>
    <div class="welcomeTitle" id="fullTitle">Hi â€”</div>
    <div class="welcomeSub" id="fullSub">Welcome back to Recruita.</div>
    <div style="margin-top:18px;">
      <button id="fullContinue" class="blueBtn">Continue</button>
    </div>
  </div>
</div>

<div id="dupModal" role="dialog" aria-modal="true">
  <div id="dupCard" role="document">
    <h3>Possible duplicate found</h3>
    <div id="dupList"></div>
    <div style="margin-top:8px; font-size:13px; color:rgba(255,255,255,0.7);">
      Choose an action â€” completing previous is recommended for partial drafts.
    </div>
    <div class="dupBtns">
      <button id="dupEditPrev" class="greyBtn">Complete previous</button>
      <button id="dupSaveNew" class="blueBtn">Save as new</button>
      <button id="dupDismiss" class="redBtn">Dismiss</button>
    </div>
  </div>
</div>

<div id="welcomeMini" aria-live="polite" role="status" style="display:none">
  <div style="display:flex;flex-direction:column;">
    <div class="title" id="miniTitle">Hi â€”</div>
    <div class="sub" id="miniSub">Welcome back.</div>
  </div>
  <div style="flex:1"></div>
  <button id="miniClose" title="Dismiss">âœ•</button>
</div>

<script type="module">
/* Firebase imports (uses your firebase.js) */
import { auth, db } from "./firebase.js";
import {
  collection, query, where, onSnapshot, addDoc, getDocs, limit, doc, updateDoc
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

/* State */
let uid = "", email = "", empID = "", displayName = "";
let table = null, all = [];
let editingDocId = null;
let lastDupMatches = [];

/* Elements */
const dupHint = document.getElementById('dupHint');
const dupModal = document.getElementById('dupModal');
const dupList = document.getElementById('dupList');
const dupEditPrev = document.getElementById('dupEditPrev');
const dupSaveNew = document.getElementById('dupSaveNew');
const dupDismiss = document.getElementById('dupDismiss');

const welcomeFull = document.getElementById('welcomeFull');
const fullAvatar = document.getElementById('fullAvatar');
const fullTitle = document.getElementById('fullTitle');
const fullSub = document.getElementById('fullSub');
const fullContinue = document.getElementById('fullContinue');

const nameBadge = document.getElementById('nameBadge');
const badgeAvatar = document.getElementById('badgeAvatar');
const badgeText = document.getElementById('badgeText');

const cartoonBox = document.getElementById('cartoonBox');
const cartoonGreet = document.getElementById('cartoonGreet');
const cartoonLine = document.getElementById('cartoonLine');

const miniClose = document.getElementById('miniClose');

const KEY_LAST_FULL = 'recruita_lastFullWelcome';
const KEY_LAST_LOGOUT = 'recruita_lastLogout';
const KEY_BADGE_VISIBLE = 'recruita_nameBadgeVisible';

/* Helpers */
function formatTS(d){ const p=n=>n.toString().padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`; }
function debounce(fn, wait){ let t=null; return function(...a){ clearTimeout(t); t=setTimeout(()=>fn.apply(this,a), wait); }; }

function playJingle(){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const seq = [660,880,990];
    let t = ctx.currentTime;
    seq.forEach((freq,i)=>{
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type='sine'; o.frequency.setValueAtTime(freq, t);
      g.gain.setValueAtTime(0.0001, t);
      g.gain.linearRampToValueAtTime(0.09, t+0.01);
      g.gain.linearRampToValueAtTime(0.0001, t+0.22);
      o.connect(g).connect(ctx.destination);
      o.start(t); o.stop(t+0.23);
      t += 0.12;
    });
    setTimeout(()=>{ try{ ctx.close(); }catch(e){} }, 800);
  }catch(e){ console.warn('Audio not supported', e); }
}

function showCartoon(name){
  cartoonGreet.textContent = `Hey ${name} â€”`;
  cartoonLine.textContent = "What's up? ðŸŽµ";
  cartoonBox.style.display = 'block';
  cartoonBox.style.opacity = '1';
  playJingle();
  setTimeout(()=> { cartoonBox.style.opacity = '0'; setTimeout(()=> cartoonBox.style.display='none', 320); }, 4200);
}

function minimizeIntoBadge(name){
  if(sessionStorage.getItem(KEY_BADGE_VISIBLE)) return;
  welcomeFull.classList.add('minimize');
  const fallbackMs = 700; let done=false;
  function finish(){
    if(done) return; done=true;
    welcomeFull.style.display = 'none';
    badgeAvatar.textContent = (name && name[0]) ? name[0].toUpperCase() : 'R';
    badgeText.textContent = name;
    nameBadge.style.display = 'flex';
    sessionStorage.setItem(KEY_BADGE_VISIBLE, '1');
    try{ localStorage.setItem(KEY_LAST_FULL, Date.now().toString()); }catch(e){}
  }
  welcomeFull.addEventListener('transitionend', function onEnd(ev){
    if(ev.propertyName && ev.propertyName.indexOf('transform') === -1) return;
    welcomeFull.removeEventListener('transitionend', onEnd);
    finish();
  });
  setTimeout(()=> finish(), fallbackMs);
}

function openDupModal(matches){
  lastDupMatches = matches;
  dupList.innerHTML = '';
  matches.forEach(m=>{
    const when = m.ts || m.createdAt || '';
    const status = m.status || 'complete';
    const snippet = `
      <div class="dupItem">
        <div><strong>${m.name || '(no name)'}</strong> â€” ${m.number}</div>
        <div style="font-size:12px;color:rgba(255,255,255,0.6);margin-top:6px;">
          status: ${status} â€¢ ${when}
          ${m.channel ? ' â€¢ ' + m.channel : ''}
          ${m.remarks ? ' â€¢ ' + (m.remarks.length>40 ? m.remarks.slice(0,40)+'â€¦' : m.remarks) : ''}
        </div>
      </div>`;
    dupList.insertAdjacentHTML('beforeend', snippet);
  });
  dupModal.style.display = 'flex';
}
function closeDupModal(){ dupModal.style.display = 'none'; }

/* NEW: checkMatches now queries both createdBy==uid AND empID==empID (in two queries) and merges results.
   That ensures older rows saved before `createdBy` existed (but with empID) are still found.
*/
async function checkMatches(number){
  if(!number || number.length < 6) return [];
  try{
    const results = [];
    // Query A: records created by this auth uid
    const qA = query(collection(db,'callLogs'), where('number','==', number), where('createdBy','==', uid), limit(50));
    const snapA = await getDocs(qA);
    snapA.forEach(d => results.push({...d.data(), id:d.id}));

    // Query B: records with empID equal to this user's empID (covers older records)
    if(empID){
      const qB = query(collection(db,'callLogs'), where('number','==', number), where('empID','==', empID), limit(50));
      const snapB = await getDocs(qB);
      snapB.forEach(d => {
        const id = d.id;
        // avoid duplicate id push
        if(!results.find(r=>r.id === id)) results.push({...d.data(), id});
      });
    }

    // sort by timestamp descending (newest first). handles ts as string iso-format used across files.
    results.sort((a,b)=> {
      const at = a.ts || a.createdAt || '';
      const bt = b.ts || b.createdAt || '';
      if(!at && !bt) return 0;
      if(!at) return 1;
      if(!bt) return -1;
      return bt.localeCompare(at);
    });

    return results;
  }catch(err){
    console.error('checkMatches error', err);
    return [];
  }
}

/* pre-check on number blur */
const numberEl = document.getElementById('numberInput');
const runPrecheck = debounce(async ()=>{
  const val = (numberEl.value||'').trim();
  if(!/^[0-9]{6,}$/.test(val)){ dupHint.textContent=''; return; }
  const matches = await checkMatches(val);
  if(matches.length){
    const top = matches[0], status = top.status||'complete', when = top.ts||top.createdAt||'';
    dupHint.textContent = `Existing record found (${matches.length}). Most recent: ${top.name||'(no name)'} â€¢ ${when} â€¢ ${status}. On Save you will get options.`;
  } else dupHint.textContent = '';
}, 650);
numberEl.addEventListener('blur', runPrecheck);

/* numeric enforcement */
function enforceNumericInput(el){
  el.addEventListener('input', ()=>{
    let v = el.value;
    v = v.replace(/[^\d.]/g,'');
    const parts = v.split('.');
    if(parts.length>2) v = parts[0] + '.' + parts.slice(1).join('');
    if(v.indexOf('.') === -1) v = v.replace(/^0+(\d)/, '$1');
    el.value = v;
  });
}
enforceNumericInput(document.getElementById('ageInput'));
enforceNumericInput(document.getElementById('expInput'));
enforceNumericInput(document.getElementById('ctcInput'));

/* modal buttons */
dupEditPrev.addEventListener('click', async ()=>{
  closeDupModal();
  if(!lastDupMatches.length) return;
  const top = lastDupMatches[0];
  editingDocId = top.id;
  document.getElementById('nameInput').value = top.name || '';
  document.getElementById('numberInput').value = top.number || '';
  document.getElementById('ageInput').value = top.age || '';
  document.getElementById('expInput').value = top.exp || '';
  document.getElementById('ctcInput').value = top.ctc || '';
  document.getElementById('locInput').value = top.loc || '';
  document.getElementById('compInput').value = top.comp || '';
  document.getElementById('channelInput').value = top.channel || '';
  document.getElementById('statusInput').value = top.callStatus || '';
  document.getElementById('remarkInput').value = top.remarks || '';
  dupHint.textContent = `Editing existing entry (will update record id ${editingDocId}).`;
});

dupSaveNew.addEventListener('click', async ()=>{
  closeDupModal();
  try{
    const res = await performSave({ forceNew: true, duplicateOf: (lastDupMatches[0] && lastDupMatches[0].id) || null });
    if(res === 'saved'){
      alert('Saved as new (duplicate allowed)');
      ['nameInput','numberInput','ageInput','expInput','ctcInput','locInput','compInput','channelInput','statusInput','remarkInput']
        .forEach(id => { const el = document.getElementById(id); if(el) el.value = ''; });
      dupHint.textContent = '';
    }
  }catch(e){ console.error(e); alert('Error saving new duplicate: ' + (e.message || e)); }
});

dupDismiss.addEventListener('click', ()=> closeDupModal());

/* save/update logic */
async function performSave(opts){
  opts = opts || {};
  const name = (document.getElementById('nameInput').value || '').trim();
  const number = (document.getElementById('numberInput').value || '').trim();
  const age = (document.getElementById('ageInput').value || '').trim();
  const exp = (document.getElementById('expInput').value || '').trim();
  const ctc = (document.getElementById('ctcInput').value || '').trim();
  const loc = (document.getElementById('locInput').value || '').trim();
  const comp = (document.getElementById('compInput').value || '').trim();
  const channel = (document.getElementById('channelInput').value || '').trim();
  const statusSelect = (document.getElementById('statusInput').value || '').trim();
  const remarks = (document.getElementById('remarkInput').value || '').trim();

  if(!/^[0-9]{10}$/.test(number)){
    throw new Error('Enter valid number (exactly 10 digits).');
  }

  const isPartial = !(age || exp || ctc || loc || comp || channel || statusSelect || remarks);

  // update existing
  if(editingDocId){
    try{
      const ref = doc(db, 'callLogs', editingDocId);
      await updateDoc(ref, {
        ts: formatTS(new Date()),
        name, number, age, exp, ctc, loc, comp,
        channel, callStatus: statusSelect, remarks,
        status: 'complete',
        updatedBy: uid,
        updatedAt: formatTS(new Date()),
        empID: empID
      });
      editingDocId = null;
      dupHint.textContent = '';
      return 'saved';
    }catch(err){ console.error('update error', err); throw err; }
  }

  // forced new from modal
  if(opts.forceNew){
    try{
      await addDoc(collection(db,'callLogs'), {
        ts: formatTS(new Date()),
        name, number, age, exp, ctc, loc, comp,
        channel, callStatus: statusSelect, remarks,
        createdBy: uid,
        createdAt: formatTS(new Date()),
        empID: empID,
        status: isPartial ? 'partial' : 'complete',
        isDuplicate: !!opts.duplicateOf,
        duplicateOf: opts.duplicateOf || null
      });
      return 'saved';
    }catch(err){ console.error('add forceNew error', err); throw err; }
  }

  // normal duplicate check (scoped to current recruiter - now robust)
  const matches = await checkMatches(number);
  if(matches.length){
    openDupModal(matches);
    return 'prompt';
  }

  // create new
  try{
    await addDoc(collection(db,'callLogs'), {
      ts: formatTS(new Date()),
      name, number, age, exp, ctc, loc, comp,
      channel, callStatus: statusSelect, remarks,
      createdBy: uid,
      createdAt: formatTS(new Date()),
      empID: empID,
      status: isPartial ? 'partial' : 'complete'
    });
    return 'saved';
  }catch(err){ console.error('add error', err); throw err; }
}

async function saveData(evt){
  const btn = document.getElementById('submitBtn');
  if(btn) btn.disabled = true;
  try{
    const result = await performSave();
    if(result === 'saved'){
      alert('Entry saved');
      ['nameInput','numberInput','ageInput','expInput','ctcInput','locInput','compInput','channelInput','statusInput','remarkInput']
        .forEach(id => { const el = document.getElementById(id); if(el) el.value = ''; });
      dupHint.textContent = '';
    } else if(result === 'prompt'){
      // modal shown; user must choose action
    }
  }catch(err){
    alert(err.message || 'Error saving entry');
    console.error('saveData error', err);
  }finally{ if(btn) btn.disabled = false; }
}

/* CSV export */
function exportCSV(){ if(table && typeof table.download === 'function'){ table.download('csv', `${(displayName||empID).replace(/\s+/g,'_')}_data.csv`); } else alert('Table not ready yet.'); }
function toggleTheme(){ document.body.classList.toggle('light'); const tb = document.querySelector('.tabulator'); if(tb) tb.classList.toggle('tabulator_midnight'); }
function logout(){ try{ localStorage.setItem(KEY_LAST_LOGOUT, Date.now().toString()); }catch(e){} try{ sessionStorage.removeItem(KEY_BADGE_VISIBLE); }catch(e){} try{ nameBadge.style.display = 'none'; }catch(e){} auth.signOut(); location.href = 'login.html'; }

function showMini(name){
  document.getElementById('miniTitle').textContent = `Hi ${name} !`;
  document.getElementById('miniSub').textContent = 'Welcome back.';
  const mini = document.getElementById('welcomeMini');
  mini.style.display = 'flex';
  requestAnimationFrame(()=> mini.classList.add('show'));
  setTimeout(()=> { mini.classList.remove('show'); setTimeout(()=> mini.style.display='none',320); }, 3500);
}

/* Improved welcome logic:
   Force show if there is no prior KEY_LAST_FULL (first time), or doc didn't load quickly.
*/
function handleWelcomeLogic(forceShow){
  const lastFull = localStorage.getItem(KEY_LAST_FULL);
  const lastLogout = localStorage.getItem(KEY_LAST_LOGOUT);
  const twelvePassed = (Date.now() - (Number(lastFull) || 0)) / (1000*60*60) >= 12;
  const afterLogout = !!lastLogout && Number(lastLogout) > Number(lastFull || 0);
  const badgeVisible = !!sessionStorage.getItem(KEY_BADGE_VISIBLE);

  if(badgeVisible){
    badgeAvatar.textContent = (displayName && displayName[0]) ? displayName[0].toUpperCase() : 'R';
    badgeText.textContent = displayName || empID;
    nameBadge.style.display = 'flex';
    return;
  }

  if(forceShow || afterLogout || twelvePassed){
    fullAvatar.textContent = (displayName && displayName[0]) ? displayName[0].toUpperCase() : 'R';
    fullTitle.textContent = `Hi ${displayName || empID} !`;
    fullSub.textContent = 'Welcome back to Recruita.';
    welcomeFull.style.display = 'flex';
    welcomeFull.setAttribute('aria-hidden','false');
    return;
  }

  const shownKey = `welcomeMiniShown_${uid}`;
  if(!sessionStorage.getItem(shownKey)){
    showMini(displayName || empID);
    sessionStorage.setItem(shownKey,'1');
  }
}

/* UI binds */
fullContinue.addEventListener('click', ()=> minimizeIntoBadge(displayName || empID));
nameBadge.addEventListener('click', ()=> showCartoon(displayName || empID));
miniClose.addEventListener('click', ()=> { const mini = document.getElementById('welcomeMini'); mini.classList.remove('show'); setTimeout(()=> mini.style.display='none',320); });

/* Auth -> get user doc -> then register callLogs listener */
auth.onAuthStateChanged(async user => {
  if(!user){ location.href='login.html'; return; }
  uid = user.uid; email = user.email;

  const ref = collection(db,'users');
  const q = query(ref, where('email','==', email));

  let docLoaded = false;
  const waitForDoc = new Promise((resolve) => {
    const unsub = onSnapshot(q, snap => {
      snap.forEach(d => {
        const data = d.data() || {};
        empID = data.empID || (email ? email.split('@')[0] : 'User');
        displayName = (data.fullName || data.name || empID || (email ? email.split('@')[0] : 'there')).trim();
        docLoaded = true;
      });
      resolve();
      unsub();
    }, err => {
      console.warn('user doc snapshot error', err);
      resolve();
      unsub();
    });
  });

  const timeout = new Promise(r => setTimeout(r, 900));
  await Promise.race([waitForDoc, timeout]);

  // Now register listener using the determined empID
  loadData(empID);

  // Force show welcome if first time (no KEY_LAST_FULL) or doc didn't load
  const forceShow = !localStorage.getItem(KEY_LAST_FULL) || !docLoaded;
  handleWelcomeLogic(forceShow);
});

/* Load call logs and render table */
import { collection as colRef } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js"; // alias to avoid bundling confusion

function loadData(empIDVal){
  const q = query(collection(db,'callLogs'), where('empID','==', empIDVal));
  onSnapshot(q, snap => {
    all = [];
    snap.forEach(d => all.push({...d.data(), id:d.id}));
    all.sort((a,b)=> new Date(b.ts) - new Date(a.ts));
    renderDashboard();
    renderTable(all);
  });
}

function renderDashboard(){
  const today = new Date().toDateString();
  const countToday = all.filter(e => new Date(e.ts).toDateString() === today).length;
  document.getElementById('dashBody').innerHTML = `
    <tr>
      <td style="border:1px solid rgba(255,255,255,0.06); padding:10px;">${displayName || empID}</td>
      <td style="border:1px solid rgba(255,255,255,0.06); padding:10px;">${countToday}</td>
      <td style="border:1px solid rgba(255,255,255,0.06); padding:10px;">${all.length}</td>
    </tr>`;
}

function renderTable(data){
  if(table){ table.replaceData(data); return; }
  table = new Tabulator('#listTable', {
    data, layout:'fitDataFill', responsiveLayout:false, height:'480px',
    movableColumns:true, pagination:false, columnDefaults:{ resizable:true },
    columns:[
      {title:'Call', field:'number', formatter:cell=>`<a href="tel:${cell.getValue()}" style="color:var(--blue);font-size:20px;">ðŸ“ž</a>`},
      {title:'Time â–¼', field:'ts', sorter:'datetime', headerFilter:'input'},
      {title:'Name â–¼', field:'name', sorter:'string', headerFilter:'input'},
      {title:'Number â–¼', field:'number', sorter:'number', headerFilter:'input'},
      {title:'Age â–¼', field:'age', sorter:'number', headerFilter:'input'},
      {title:'Experience â–¼', field:'exp', sorter:'number', headerFilter:'input'},
      {title:'Location â–¼', field:'loc', sorter:'string', headerFilter:'input'},
      {title:'CTC â–¼', field:'ctc', sorter:'number', headerFilter:'input'},
      {title:'Company â–¼', field:'comp', sorter:'string', headerFilter:'input'},
      {title:'Channel â–¼', field:'channel', sorter:'string', headerFilter:'input'},
      {title:'Status â–¼', field:'callStatus', sorter:'string', headerFilter:'input'},
      {title:'Remarks â–¼', field:'remarks', sorter:'string', headerFilter:'input'},
    ]
  });
}

/* expose small set for debug/inline */
window.saveData = saveData;
window.exportCSV = exportCSV;
window.toggleTheme = toggleTheme;
window.logout = logout;
</script>
</body>
</html>
