<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Admin Panel</title>

<style>
:root {
  --bg: #0b0b0c;
  --card: #111;
  --text: #fff;
  --text-light: #bbb;
  --btn: #2B7FFF;
  --table-border: #444;
}

.light {
  --bg: #f5f5f5;
  --card: #fff;
  --text: #000;
  --text-light: #555;
  --btn: #0066ff;
  --table-border: #ddd;
}

body{
  background:var(--bg);
  color:var(--text);
  font-family:Inter, sans-serif;
  padding:20px;
}

.container{max-width:1100px; margin:auto;}

h2{margin-top:25px;margin-bottom:12px;}

input, select{
  width:100%;padding:12px;border-radius:8px;border:none;margin-top:10px;
}

button{
  padding:10px 20px;background:var(--btn);border:none;border-radius:8px;
  color:white;font-weight:600;cursor:pointer;
}

button:active{transform:scale(0.96);}

.tableBox{
  width:100%;overflow-x:auto;margin-top:20px;
}

table{
  width:100%;border-collapse:collapse;margin-top:10px;
}
th,td{
  padding:10px;border:1px solid var(--table-border);text-align:left;
}
th{background:var(--card);}
.entryCard{
  background:var(--card);padding:20px;border-radius:12px;margin-top:20px;
}
.actionBtn{
  padding:6px 10px;font-size:13px;border-radius:6px;
}
.del{background:#d9534f;}
.edit{background:#5bc0de;}
.topBar{
  display:flex;justify-content:flex-end;gap:10px;margin-bottom:20px;
}
</style>
</head>

<body>

<div class="container">

<div class="topBar">
  <button id="themeBtn">Toggle Theme</button>
  <button id="logoutBtn">Logout</button>
</div>

<h2>Recruiter Performance Dashboard</h2>
<div class="tableBox">
<table id="dashTable">
  <thead>
    <tr>
      <th>EmpID</th>
      <th>Today's Count</th>
      <th>All-Time Count</th>
    </tr>
  </thead>
  <tbody id="dashBody"></tbody>
</table>
</div>

<h2>Add Candidate Entry</h2>

<input id="name" placeholder="Candidate Name">
<input id="number" placeholder="Candidate Number">
<input id="age" placeholder="Age">
<input id="exp" placeholder="Total Experience">
<input id="loc" placeholder="Location">
<input id="ctc" placeholder="Current CTC">
<input id="comp" placeholder="Current Company">

<select id="channel">
  <option value="">Select Channel</option>
  <option>Banca</option>
  <option>Agency</option>
  <option>Direct</option>
  <option>Tele calling</option>
</select>

<input id="remarks" placeholder="Remarks">

<button id="saveBtn">Submit Entry</button>

<h2>All Entries</h2>

<button id="csvBtn">Download CSV</button>

<div class="tableBox">
<table id="dataTable">
  <thead>
    <tr>
      <th>Time</th>
      <th>EmpID</th>
      <th>Name</th>
      <th>Number</th>
      <th>Age</th>
      <th>Experience</th>
      <th>Location</th>
      <th>CTC</th>
      <th>Company</th>
      <th>Channel</th>
      <th>Remarks</th>
      <th>Edit</th>
      <th>Delete</th>
    </tr>
  </thead>
  <tbody id="dataBody"></tbody>
</table>
</div>

</div>

<script type="module">
import { auth, db, getUserInfo } from "./firebase.js";
import {
  addDoc, collection, onSnapshot, doc, updateDoc, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

// ------------------------ LOGIN CHECK -------------------------
auth.onAuthStateChanged(async u=>{
  if(!u) location.href="login.html";

  const info = await getUserInfo();
  if(!info || info.role!=="admin") location.href="login.html";

  window.empID = info.empID;
});

// ------------------------ THEME -------------------------
let theme = localStorage.getItem("theme") || "dark";
applyTheme(theme);

document.getElementById("themeBtn").onclick = ()=>{
  theme = theme==="dark" ? "light" : "dark";
  applyTheme(theme);
};

function applyTheme(t){
  if(t==="light") document.body.classList.add("light");
  else document.body.classList.remove("light");
  localStorage.setItem("theme",t);
}

// ------------------------ LOGOUT -------------------------
document.getElementById("logoutBtn").onclick = ()=>{
  auth.signOut();
};

// ------------------------ REALTIME FETCH -------------------------
let ALL = [];

onSnapshot(collection(db,"callLogs"),(snap)=>{
  ALL = [];
  snap.forEach(d=>{
    ALL.push({ id: d.id, ...d.data() });
  });
  renderDashboard();
  renderTable();
});

// ------------------------ DUPLICATE CHECK -------------------------
async function alreadyExists(number){
  return ALL.some(e=> e.number === number);
}

// ------------------------ SAVE ENTRY -------------------------
document.getElementById("saveBtn").onclick = async ()=>{

  let number = numberInput.value.trim();
  if(number.length!==10){
    alert("10-digit number required");
    return;
  }

  const duplicate = ALL.find(e=> e.number===number && e.empID!==window.empID);
  if(duplicate){
    if(!confirm("Duplicate entry exists by another recruiter. Still add?")) return;
  }

  await addDoc(collection(db,"callLogs"),{
    ts: new Date().toISOString(),
    empID: window.empID,
    name: name.value,
    number,
    age: age.value || "",
    exp: exp.value || "",
    loc: loc.value || "",
    ctc: ctc.value || "",
    comp: comp.value || "",
    channel: channel.value || "",
    remarks: remarks.value || ""
  });

  alert("Saved");
  name.value = numberInput.value = age.value = exp.value = loc.value =
  ctc.value = comp.value = channel.value = remarks.value = "";
};

// ------------------------ RENDER DASHBOARD -------------------------
function renderDashboard(){
  let map = {};

  ALL.forEach(e=>{
    if(!map[e.empID]) map[e.empID] = { today:0, all:0 };
    map[e.empID].all++;
    if(e.ts.slice(0,10) === new Date().toISOString().slice(0,10)){
      map[e.empID].today++;
    }
  });

  dashBody.innerHTML = "";
  Object.keys(map).forEach(id=>{
    dashBody.innerHTML += `
      <tr>
        <td>${id}</td>
        <td>${map[id].today}</td>
        <td>${map[id].all}</td>
      </tr>
    `;
  });
}

// ------------------------ RENDER TABLE -------------------------
function renderTable(){
  dataBody.innerHTML = "";
  ALL.forEach(e=>{
    dataBody.innerHTML += `
      <tr>
        <td>${new Date(e.ts).toLocaleString()}</td>
        <td>${e.empID}</td>
        <td>${e.name}</td>
        <td>${e.number}</td>
        <td>${e.age}</td>
        <td>${e.exp}</td>
        <td>${e.loc}</td>
        <td>${e.ctc}</td>
        <td>${e.comp}</td>
        <td>${e.channel}</td>
        <td>${e.remarks}</td>
        <td><button class="actionBtn edit" onclick="editEntry('${e.id}')">Edit</button></td>
        <td><button class="actionBtn del" onclick="delEntry('${e.id}')">Delete</button></td>
      </tr>
    `;
  });
}

// ------------------------ DELETE -------------------------
window.delEntry = async(id)=>{
  if(confirm("Delete this entry?")){
    await deleteDoc(doc(db,"callLogs",id));
  }
};

// ------------------------ EDIT -------------------------
window.editEntry = async(id)=>{
  let e = ALL.find(x=>x.id===id);
  let newRemark = prompt("Edit remark:", e.remarks);
  if(newRemark!==null){
    await updateDoc(doc(db,"callLogs",id),{ remarks:newRemark });
  }
};

// ------------------------ CSV DOWNLOAD -------------------------
csvBtn.onclick = ()=>{
  let csv = "Timestamp,EmpID,Name,Number,Age,Experience,Location,CTC,Company,Channel,Remarks\n";
  ALL.forEach(e=>{
    csv += `${e.ts},${e.empID},${e.name},${e.number},${e.age},${e.exp},${e.loc},${e.ctc},${e.comp},${e.channel},${e.remarks}\n`;
  });

  let blob = new Blob([csv],{type:"text/csv"});
  let a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "Recruita_Full_Data.csv";
  a.click();
};
</script>

</body>
</html>
