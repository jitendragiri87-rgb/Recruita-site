<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admin Panel - Recruita</title>

<style>
    body {
        font-family: Inter, sans-serif;
        padding: 20px;
        transition: 0.3s;
    }

    body.dark {
        background: #0b0b0c;
        color: white;
    }

    body.light {
        background: #f5f5f5;
        color: #222;
    }

    h2 {
        margin-top: 20px;
        margin-bottom: 10px;
    }

    input, select {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #555;
        margin-top: 10px;
        background: #fff;
    }

    body.dark input, body.dark select {
        background: #111;
        color: white;
        border: none;
    }

    button {
        padding: 12px 18px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        margin-top: 10px;
    }

    .blueBtn { background: #2B7FFF; color: white; }
    .redBtn { background: #e74c3c; color: white; }
    .grayBtn { background: gray; color: white; }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    th, td {
        padding: 10px;
        border: 1px solid #444;
        text-align: left;
    }

    /* Top-right actions */
    .topBar {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-bottom: 20px;
    }
</style>
</head>

<body class="dark">

<div class="topBar">
    <button id="themeToggle" class="grayBtn">Toggle Theme</button>
    <button onclick="logout()" class="redBtn">Logout</button>
</div>

<h2>Admin Dashboard</h2>
<table id="dashboardTable">
    <tr>
        <th>EmpID</th>
        <th>Today's Count</th>
        <th>All-Time Count</th>
    </tr>
</table>

<h2>Add Candidate Entry</h2>

<input id="name" placeholder="Candidate Name">
<input id="number" placeholder="10 Digit Mobile Number">
<input id="age" placeholder="Age">
<input id="expYears" placeholder="Total Experience (Years)">
<input id="loc" placeholder="Location">
<input id="ctc" placeholder="CTC">
<input id="comp" placeholder="Current Company">

<select id="channel">
    <option value="">Select Channel</option>
    <option>Banca</option>
    <option>Agency</option>
    <option>Direct</option>
    <option>Tele calling</option>
</select>

<input id="remarks" placeholder="Remarks">

<button class="blueBtn" id="submitBtn" onclick="saveData()">Submit Entry</button>


<h2>All Entries</h2>
<button class="blueBtn" onclick="exportCSV()">Download Full CSV</button>

<table id="dataTable">
    <thead>
        <tr>
            <th>Time</th>
            <th>EmpID</th>
            <th>Name</th>
            <th>Number</th>
            <th>Age</th>
            <th>Experience</th>
            <th>Location</th>
            <th>CTC</th>
            <th>Company</th>
            <th>Channel</th>
            <th>Remarks</th>
            <th>Edit</th>
            <th>Delete</th>
        </tr>
    </thead>
    <tbody id="tableBody"></tbody>
</table>


<script type="module">
import { auth, db } from "./firebase.js";
import {
    addDoc, collection, getDocs, deleteDoc, updateDoc,
    doc, onSnapshot, query, where
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

let ADMIN_EMAIL = "";
let EMPID = "";
let ALL = [];

/* ---------------------- AUTH CHECK --------------------- */
auth.onAuthStateChanged(async user => {
    if (!user) {
        window.location = "login.html";
        return;
    }

    ADMIN_EMAIL = user.email;

    // fetch empID
    let usersQ = query(collection(db, "users"), where("email", "==", user.email));
    let snap = await getDocs(usersQ);
    snap.forEach(d => EMPID = d.data().empID);

    loadData();
});


/* -------------------- REAL-TIME FETCH -------------------- */
function loadData() {
    onSnapshot(collection(db, "callLogs"), snap => {
        ALL = [];
        snap.forEach(d => ALL.push({ id: d.id, ...d.data() }));
        renderTable();
        renderDashboard();
    });
}


/* ------------------ DASHBOARD COUNTS ------------------ */
function renderDashboard() {
    let map = {};

    ALL.forEach(e => {
        if (!map[e.empID]) map[e.empID] = { today: 0, total: 0 };

        let today = new Date().toDateString();
        let entryDate = new Date(e.ts).toDateString();

        if (today === entryDate) map[e.empID].today++;
        map[e.empID].total++;
    });

    dashboardTable.innerHTML = `
        <tr><th>EmpID</th><th>Today's Count</th><th>All-Time Count</th></tr>
    `;

    Object.keys(map).forEach(id => {
        dashboardTable.innerHTML += `
            <tr>
                <td>${id}</td>
                <td>${map[id].today}</td>
                <td>${map[id].total}</td>
            </tr>
        `;
    });
}


/* ---------------------- ADD ENTRY ---------------------- */
async function saveData() {

    let num = number.value.trim();
    if (num.length !== 10) {
        alert("Enter valid 10 digit number");
        return;
    }

    // duplicate check
    let duplicate = ALL.find(e => e.number === num && e.empID === EMPID);

    if (duplicate) {
        let ok = confirm("Duplicate entry found. Still want to add?");
        if (!ok) return;
    }

    let data = {
        ts: new Date().toISOString(),
        empID: EMPID,
        email: ADMIN_EMAIL,
        name: name.value || "",
        number: num,
        age: age.value || "",
        expYears: expYears.value || "",
        loc: loc.value || "",
        ctc: ctc.value || "",
        comp: comp.value || "",
        channel: channel.value || "",
        remarks: remarks.value || ""
    };

    await addDoc(collection(db, "callLogs"), data);
    alert("Entry Saved");

    // Reset fields
    name.value = "";
    number.value = "";
    age.value = "";
    expYears.value = "";
    loc.value = "";
    ctc.value = "";
    comp.value = "";
    channel.value = "";
    remarks.value = "";
}


/* ---------------------- RENDER TABLE ---------------------- */
function renderTable() {
    tableBody.innerHTML = "";

    ALL.forEach(e => {
        tableBody.innerHTML += `
        <tr>
            <td>${new Date(e.ts).toLocaleString()}</td>
            <td>${e.empID}</td>
            <td>${e.name}</td>
            <td>${e.number}</td>
            <td>${e.age}</td>
            <td>${e.expYears}</td>
            <td>${e.loc}</td>
            <td>${e.ctc}</td>
            <td>${e.comp}</td>
            <td>${e.channel}</td>
            <td>${e.remarks}</td>

            <td><button class="grayBtn" onclick="editEntry('${e.id}')">Edit</button></td>
            <td><button class="redBtn" onclick="deleteEntry('${e.id}')">Delete</button></td>
        </tr>`;
    });
}


/* ---------------------- DELETE ---------------------- */
window.deleteEntry = async (id) => {
    if (!confirm("Delete this entry?")) return;
    await deleteDoc(doc(db, "callLogs", id));
};


/* ---------------------- EDIT ---------------------- */
window.editEntry = async (id) => {

    let item = ALL.find(e => e.id === id);

    let newName = prompt("Name:", item.name);
    let newNum  = prompt("Number:", item.number);
    let newAge  = prompt("Age:", item.age);
    let newExp  = prompt("Experience (years):", item.expYears);
    let newLoc  = prompt("Location:", item.loc);
    let newCTC  = prompt("CTC:", item.ctc);
    let newComp = prompt("Company:", item.comp);
    let newCh   = prompt("Channel:", item.channel);
    let newRem  = prompt("Remarks:", item.remarks);

    await updateDoc(doc(db, "callLogs", id), {
        name: newName,
        number: newNum,
        age: newAge,
        expYears: newExp,
        loc: newLoc,
        ctc: newCTC,
        comp: newComp,
        channel: newCh,
        remarks: newRem
    });
};


/* ---------------------- CSV EXPORT ---------------------- */
window.exportCSV = () => {
    let csv = "Time,EmpID,Name,Number,Age,Experience,Location,CTC,Company,Channel,Remarks\n";

    ALL.forEach(e => {
        csv += `${e.ts},${e.empID},${e.name},${e.number},${e.age},${e.expYears},${e.loc},${e.ctc},${e.comp},${e.channel},${e.remarks}\n`;
    });

    let blob = new Blob([csv], { type: "text/csv" });
    let a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "Recruita_Full_Data.csv";
    a.click();
};


/* ---------------------- LOGOUT ---------------------- */
window.logout = () => {
    auth.signOut();
};


/* ---------------------- THEME TOGGLE ---------------------- */
themeToggle.onclick = () => {
    if (document.body.classList.contains("dark")) {
        document.body.classList.replace("dark", "light");
    } else {
        document.body.classList.replace("light", "dark");
    }
};
</script>

</body>
</html>
