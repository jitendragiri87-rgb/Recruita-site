<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Recruita Admin Panel</title>

<style>
/* ---- SAME CSS (unchanged) ---- */
body {
    background:#0b0b0c;
    color:white;
    font-family:Inter, sans-serif;
    padding:20px;
}
.light { background:#f2f2f2; color:#222; }

.topBar {
    display:flex;
    justify-content:flex-end;
    gap:12px;
    margin-bottom:20px;
}

button {
    padding:10px 18px;
    border:none;
    border-radius:6px;
    cursor:pointer;
    font-weight:600;
}
.blueBtn { background:#2B7FFF; color:white; }
.redBtn { background:#e74c3c; color:white; }
.greyBtn { background:#555; color:white; }

.callBtn {
    padding:6px 10px;
    background:#2B7FFF;
    color:white;
    border-radius:6px;
    text-decoration:none;
}

input, select {
    width:100%;
    padding:12px;
    background:#111;
    color:white;
    border:none;
    border-radius:8px;
    margin-top:8px;
}
.light input, .light select { background:white; color:#222; border:1px solid #ccc; }

.tableBox { overflow-x:auto; margin-top:20px; }

table {
    width:100%;
    margin-top:15px;
    border-collapse:collapse;
}
th, td {
    border:1px solid #333;
    padding:10px;
}
.light th, .light td { border:1px solid #ccc; }

.filterBox {
    margin-top:20px;
    padding:20px;
    background:#111;
    border-radius:12px;
}
.light .filterBox { background:white; border:1px solid #ccc; }

.editInput {
    background:#222;
    color:white;
    padding:6px;
    border-radius:6px;
    width:100%;
}
.light .editInput { background:#fff; color:#222; }

</style>
</head>

<body>

<!--  âœ… ADDED Manage Users + Back Button -->
<div class="topBar">
    <button onclick="goBack()" class="greyBtn">â¬… Back</button>
    <button onclick="openManageUsers()" class="blueBtn">Manage Users</button>
    <button onclick="toggleTheme()" class="greyBtn">ðŸŒ“ Theme</button>
    <button onclick="logout()" class="redBtn">Logout</button>
</div>

<h2>Admin Dashboard</h2>

<div class="tableBox">
<table>
    <thead>
        <tr>
            <th>User</th>
            <th>Today</th>
            <th>Total</th>
        </tr>
    </thead>
    <tbody id="dashBody"></tbody>
</table>
</div>

<h2>Add Candidate Entry</h2>

<input id="nameInput" placeholder="Name">
<input id="numberInput" placeholder="Number (10 digits)">
<input id="ageInput" placeholder="Age">
<input id="expInput" placeholder="Total Experience">
<input id="locInput" placeholder="Location">
<input id="ctcInput" placeholder="CTC">
<input id="compInput" placeholder="Current Company">

<select id="channelInput">
    <option value="">Select Channel</option>
    <option>Banca</option>
    <option>Agency</option>
    <option>Direct</option>
    <option>Tele calling</option>
</select>

<select id="statusInput">
    <option value="">Call Status</option>
    <option>Interested</option>
    <option>Not Interested</option>
    <option>Not Answered</option>
</select>

<input id="remarkInput" placeholder="Remarks">

<button class="blueBtn" onclick="saveData()">Submit Entry</button>

<!-- FILTER + CSV BUTTONS -->
<div style="display:flex; gap:12px; margin-top:25px;">
    <button class="blueBtn" onclick="exportCSV()">Download CSV</button>
    <button id="filterToggleBtn" class="greyBtn" onclick="toggleFilters()">Filter</button>
</div>

<!-- FILTER PANEL (UNCHANGED) -->
<div id="filterPanel" style="display:none;">
    <div class="filterBox">

        <input id="f_name" placeholder="Filter by Name">
        <input id="f_number" placeholder="Filter by Number">
        <input id="f_company" placeholder="Filter by Company">
        <input id="f_location" placeholder="Filter by Location">

        <select id="f_channel">
            <option value="">Filter by Channel</option>
            <option>Banca</option>
            <option>Agency</option>
            <option>Direct</option>
            <option>Tele calling</option>
        </select>

        <select id="f_status">
            <option value="">Filter by Call Status</option>
            <option>Interested</option>
            <option>Not Interested</option>
            <option>Not Answered</option>
        </select>

        <input id="f_empid" placeholder="Filter by EmpID or User">

        <input id="f_minAge" placeholder="Min Age">
        <input id="f_maxAge" placeholder="Max Age">

        <input id="f_minCTC" placeholder="Min CTC">
        <input id="f_maxCTC" placeholder="Max CTC">

        <label>Start Date</label>
        <input id="f_dateStart" type="date">

        <label>End Date</label>
        <input id="f_dateEnd" type="date">

        <button class="blueBtn" onclick="applyFilters()">Apply Filters</button>
        <button class="greyBtn" onclick="resetFilters()">Reset</button>
    </div>
</div>

<h2>All Entries</h2>

<div class="tableBox">
<table>
  <thead>
    <tr>
      <th>Call</th>
      <th>Time</th>
      <th>User</th>
      <th>Name</th>
      <th>Number</th>
      <th>Age</th>
      <th>Experience</th>
      <th>Location</th>
      <th>CTC</th>
      <th>Company</th>
      <th>Channel</th>
      <th>Status</th>
      <th>Remarks</th>
      <th>Edit</th>
      <th>Delete</th>
    </tr>
  </thead>
  <tbody id="listBody"></tbody>
</table>
</div>

<script type="module">

import { auth, db } from "./firebase.js";
import {
  addDoc, collection, onSnapshot, deleteDoc,
  updateDoc, doc, query, where, getDocs
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

let all = [];
let adminEmpID = "";
let adminEmail = "";
let adminUID = "";
let displayName = "";
let usersMap = {}; // empID -> displayName
let editingID = null;
let filteredData = [];

/* Timestamp */
function formatTS(d){
    const p=n=>n.toString().padStart(2,"0");
    return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;
}

/* Build usersMap so dashboard shows name instead of EmpID */
function loadUsersMap(){
    const ref = collection(db,"users");
    // listen for realtime updates to keep mapping fresh
    onSnapshot(ref, snap=>{
        usersMap = {};
        snap.forEach(d=>{
            const data = d.data() || {};
            const id = data.empID || d.id;
            const name = data.fullName || data.name || id;
            usersMap[id] = name;
        });
        // re-render dashboard/table to reflect any name updates
        renderDashboard();
        renderTable();
    });
}

/* Auth */
auth.onAuthStateChanged(async user=>{
    if(!user){ location.href="login.html"; return; }

    adminUID = user.uid;
    adminEmail = user.email;

    // fetch admin user's doc to get empID and displayName
    let ref = collection(db,"users");
    let q = query(ref, where("email","==", adminEmail));
    let snap = await getDocs(q);
    snap.forEach(d => {
        adminEmpID = d.data().empID || "";
        displayName = d.data().fullName || d.data().name || adminEmpID || adminEmail.split('@')[0];
    });

    // users map for name display
    loadUsersMap();

    // now load entries
    loadEntries();
});

/* Load All entries */
function loadEntries(){
    onSnapshot(collection(db,"callLogs"), snap=>{
        all = [];
        snap.forEach(d => all.push({ id:d.id, ...d.data() }));
        // sort newest first
        all.sort((a,b)=> {
          const at = a.ts || a.createdAt || '';
          const bt = b.ts || b.createdAt || '';
          return (bt > at) ? 1 : ((bt < at) ? -1 : 0);
        });
        renderDashboard();
        renderTable();
    });
}

/* Dashboard: show user name instead of EmpID */
function renderDashboard(){
    dashBody.innerHTML = "";

    let stats = {};

    all.forEach(d=>{
        const key = d.empID || d.createdBy || 'unknown';
        if(!stats[key]) stats[key] = {today:0, total:0};

        let today = new Date().toDateString();
        const ts = d.ts || d.createdAt || '';
        if(ts && new Date(ts).toDateString() === today) stats[key].today++;

        stats[key].total++;
    });

    Object.keys(stats).forEach(id=>{
        const name = usersMap[id] || id;
        dashBody.innerHTML += `
            <tr>
                <td>${name}</td>
                <td>${stats[id].today}</td>
                <td>${stats[id].total}</td>
            </tr>
        `;
    });
}

/* Toggle filter panel */
function toggleFilters(){
    const panel = document.getElementById("filterPanel");
    const btn = document.getElementById("filterToggleBtn");

    if(panel.style.display === "none" || panel.style.display === ""){
        panel.style.display = "block";
        btn.textContent = "Hide Filters";
    } else {
        panel.style.display = "none";
        btn.textContent = "Filter";
    }
}

/* Save entry (admin) - duplicate check now robust like recruiter */
async function saveData(){
    let num = numberInput.value.trim();
    if(num.length !== 10){
        alert("Enter 10 digit number");
        return;
    }

    // duplicate logic: check existing entries where number matches and either
    // createdBy === current uid OR empID === adminEmpID (covers older entries)
    const duplicate = all.find(e => e.number === num && (e.createdBy === adminUID || e.empID === adminEmpID));
    if(duplicate){
        let ok = confirm("This number already exists in your entries. Still add?");
        if(!ok) return;
    }

    await addDoc(collection(db,"callLogs"),{
        ts: formatTS(new Date()),
        empID: adminEmpID,
        email: adminEmail,
        createdBy: adminUID,

        name: nameInput.value,
        number: num,
        age: ageInput.value || "",
        exp: expInput.value || "",
        loc: locInput.value || "",
        ctc: ctcInput.value || "",
        comp: compInput.value || "",
        channel: channelInput.value || "",
        callStatus: statusInput.value || "",
        remarks: remarkInput.value || ""
    });

    // Reset fields
    nameInput.value="";
    numberInput.value="";
    ageInput.value="";
    expInput.value="";
    locInput.value="";
    ctcInput.value="";
    compInput.value="";
    channelInput.value="";
    statusInput.value="";
    remarkInput.value="";

    alert("Entry Saved");
}

/* Apply Filters */
function applyFilters(){
    let data = all;

    if(f_name.value)
        data = data.filter(x => (x.name||'').toLowerCase().includes(f_name.value.toLowerCase()));

    if(f_number.value)
        data = data.filter(x => (x.number||'').includes(f_number.value));

    if(f_company.value)
        data = data.filter(x => (x.comp||'').toLowerCase().includes(f_company.value.toLowerCase()));

    if(f_location.value)
        data = data.filter(x => (x.loc||'').toLowerCase().includes(f_location.value.toLowerCase()));

    if(f_channel.value)
        data = data.filter(x => x.channel === f_channel.value);

    if(f_status.value)
        data = data.filter(x => x.callStatus === f_status.value);

    if(f_empid.value)
        data = data.filter(x => {
            const uidVal = x.empID || x.createdBy || '';
            const name = usersMap[uidVal] || uidVal;
            return (uidVal === f_empid.value) || (name && name.toLowerCase().includes(f_empid.value.toLowerCase()));
        });

    if(f_minAge.value)
        data = data.filter(x => Number(x.age) >= Number(f_minAge.value));

    if(f_maxAge.value)
        data = data.filter(x => Number(x.age) <= Number(f_maxAge.value));

    if(f_minCTC.value)
        data = data.filter(x => Number(x.ctc) >= Number(f_minCTC.value));

    if(f_maxCTC.value)
        data = data.filter(x => Number(x.ctc) <= Number(f_maxCTC.value));

    if(f_dateStart.value)
        data = data.filter(x => new Date(x.ts || x.createdAt) >= new Date(f_dateStart.value));

    if(f_dateEnd.value)
        data = data.filter(x => new Date(x.ts || x.createdAt) <= new Date(f_dateEnd.value));

    filteredData = data;
    renderTableFiltered();
}

/* Reset Filters */
function resetFilters(){
    f_name.value="";
    f_number.value="";
    f_company.value="";
    f_location.value="";
    f_channel.value="";
    f_status.value="";
    f_empid.value="";
    f_minAge.value="";
    f_maxAge.value="";
    f_minCTC.value="";
    f_maxCTC.value="";
    f_dateStart.value="";
    f_dateEnd.value="";

    filteredData = [];
    renderTable();
}

/* Render full table */
function renderTable(){
    listBody.innerHTML = "";
    all.forEach(d=> renderRow(d));
}

/* Render filtered table */
function renderTableFiltered(){
    listBody.innerHTML = "";
    filteredData.forEach(d=> renderRow(d));
}

/* Render row (shows display name) */
function renderRow(d){
    const userKey = d.empID || d.createdBy || 'unknown';
    const userName = usersMap[userKey] || userKey;

    if(editingID === d.id){
        listBody.innerHTML += `
        <tr>
            <td><a href="tel:${d.number}" class="callBtn">ðŸ“ž</a></td>
            <td>${d.ts || d.createdAt || ''}</td>
            <td>${userName}</td>

            <td><input class="editInput" id="e_name" value="${d.name || ''}"></td>
            <td><input class="editInput" id="e_number" value="${d.number || ''}"></td>
            <td><input class="editInput" id="e_age" value="${d.age || ''}"></td>
            <td><input class="editInput" id="e_exp" value="${d.exp || ''}"></td>
            <td><input class="editInput" id="e_loc" value="${d.loc || ''}"></td>
            <td><input class="editInput" id="e_ctc" value="${d.ctc || ''}"></td>
            <td><input class="editInput" id="e_comp" value="${d.comp || ''}"></td>

            <td>
                <select id="e_channel" class="editInput">
                    <option ${d.channel=="Banca"?"selected":""}>Banca</option>
                    <option ${d.channel=="Agency"?"selected":""}>Agency</option>
                    <option ${d.channel=="Direct"?"selected":""}>Direct</option>
                    <option ${d.channel=="Tele calling"?"selected":""}>Tele calling</option>
                </select>
            </td>

            <td>
                <select id="e_status" class="editInput">
                    <option ${d.callStatus=="Interested"?"selected":""}>Interested</option>
                    <option ${d.callStatus=="Not Interested"?"selected":""}>Not Interested</option>
                    <option ${d.callStatus=="Not Answered"?"selected":""}>Not Answered</option>
                </select>
            </td>

            <td><input class="editInput" id="e_remark" value="${d.remarks || ''}"></td>

            <td><button class="blueBtn" onclick="saveEdit('${d.id}')">Save</button></td>
            <td><button class="greyBtn" onclick="cancelEdit()">Cancel</button></td>
        </tr>
        `;
    } else {
        listBody.innerHTML += `
        <tr>
            <td><a href="tel:${d.number}" class="callBtn">ðŸ“ž</a></td>
            <td>${d.ts || d.createdAt || ''}</td>
            <td>${userName}</td>
            <td>${d.name || ''}</td>
            <td>${d.number || ''}</td>
            <td>${d.age || ''}</td>
            <td>${d.exp || ''}</td>
            <td>${d.loc || ''}</td>
            <td>${d.ctc || ''}</td>
            <td>${d.comp || ''}</td>
            <td>${d.channel || ''}</td>
            <td>${d.callStatus || ''}</td>
            <td>${d.remarks || ''}</td>

            <td><button class="blueBtn" onclick="startEdit('${d.id}')">Edit</button></td>
            <td><button class="redBtn" onclick="deleteEntry('${d.id}')">Delete</button></td>
        </tr>
        `;
    }
}

/* Edit */
function startEdit(id){
    editingID = id;
    renderTable();
}
function cancelEdit(){
    editingID = null;
    renderTable();
}
async function saveEdit(id){
    let ref = doc(db,"callLogs",id);

    await updateDoc(ref,{
        name: e_name.value,
        number: e_number.value,
        age: e_age.value,
        exp: e_exp.value,
        loc: e_loc.value,
        ctc: e_ctc.value,
        comp: e_comp.value,
        channel: e_channel.value,
        callStatus: e_status.value,
        remarks: e_remark.value
    });

    alert("Updated");
    editingID = null;
    renderTable();
}

/* Delete */
async function deleteEntry(id){
    if(!confirm("Delete this entry?")) return;
    await deleteDoc(doc(db,"callLogs",id));
}

/* Download CSV */
function exportCSV(){
    let data = filteredData.length > 0 ? filteredData : all;

    let csv = "Time,User,Name,Number,Age,Experience,Location,CTC,Company,Channel,Status,Remarks\n";

    data.forEach(d=>{
        const userKey = d.empID || d.createdBy || 'unknown';
        const userName = usersMap[userKey] || userKey;
        csv += `${formatTS(new Date(d.ts || d.createdAt || ''))},${userName},${d.name || ''},${d.number || ''},${d.age || ''},${d.exp || ''},${d.loc || ''},${d.ctc || ''},${d.comp || ''},${d.channel || ''},${d.callStatus || ''},${(d.remarks || '').replace(/(\r\n|\n|\r)/gm," ")}\n`;
    });

    let blob = new Blob([csv],{type:"text/csv"});
    let a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "Recruita_Full_Data.csv";
    a.click();
}

/* Navigation */
function logout(){
    auth.signOut();
    location.href="login.html";
}

function goBack(){
    history.back();
}

function openManageUsers(){
    location.href="manage_users.html";
}

/* Theme */
function toggleTheme(){
    document.body.classList.toggle("light");
}

/* Global exposure (IMPORTANT) */
window.saveData = saveData;
window.applyFilters = applyFilters;
window.resetFilters = resetFilters;
window.startEdit = startEdit;
window.saveEdit = saveEdit;
window.cancelEdit = cancelEdit;
window.deleteEntry = deleteEntry;
window.exportCSV = exportCSV;
window.toggleFilters = toggleFilters;
window.toggleTheme = toggleTheme;
window.logout = logout;
window.goBack = goBack;
window.openManageUsers = openManageUsers;

</script>
</body>
</html>
