<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Recruita User Management</title>

<style>
body {
    background:#0b0b0c;
    color:white;
    font-family:Inter,sans-serif;
    padding:20px;
}
.light { background:#f2f2f2; color:#222; }

h2 { margin-top:25px; }

input {
    width:100%;
    padding:12px;
    margin-top:8px;
    border:none;
    border-radius:8px;
    background:#111;
    color:white;
}
.light input { background:#fff; color:#222; border:1px solid #ccc; }

button{
    padding:10px 18px;
    border:none;
    border-radius:6px;
    font-weight:600;
    cursor:pointer;
}
.blueBtn{ background:#2B7FFF; color:white; }
.greyBtn{ background:#555; color:white; }
.redBtn{ background:#e74c3c; color:white; }

.tableBox{
    overflow-x:auto;
    margin-top:20px;
}

table{
    width:100%;
    border-collapse:collapse;
}
th,td{
    padding:10px;
    border:1px solid #333;
}
.light th,.light td{ border:1px solid #ccc; }

.topBar {
    display:flex;
    justify-content:flex-end;
    gap:10px;
    margin-bottom:20px;
}

.actionBtn{
    padding:6px 10px;
    border-radius:6px;
    cursor:pointer;
}
</style>
</head>

<body>

<div class="topBar">
    <button onclick="toggleTheme()" class="greyBtn">ðŸŒ“ Theme</button>
    <button onclick="logout()" class="redBtn">Logout</button>
</div>

<h1>User Management (Admin Only)</h1>

<h2>Create Recruiter</h2>

<input id="emailInput" placeholder="Recruiter Email">
<input id="passwordInput" placeholder="Password">
<button class="blueBtn" onclick="createRecruiter()">Create Recruiter</button>

<h2>All Users</h2>

<div class="tableBox">
<table>
  <thead>
    <tr>
      <th>EmpID</th>
      <th>Email</th>
      <th>Role</th>
      <th>UID</th>
      <th>Reset Password</th>
      <th>Delete</th>
    </tr>
  </thead>
  <tbody id="usersBody"></tbody>
</table>
</div>

<script type="module">
import { auth, db } from "./firebase.js";
import {
  collection, onSnapshot, doc, setDoc, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

import {
  createUserWithEmailAndPassword,
  updatePassword,
  deleteUser,
  getAuth
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

let adminRole = "";

// Auth Guard
auth.onAuthStateChanged(async user=>{
    if(!user){ location.href="login.html"; return; }

    // Check if admin
    const usersRef = collection(db,"users");

    onSnapshot(usersRef, snap=>{
        let found = false;
        snap.forEach(d=>{
            if(d.data().email === user.email && d.data().role === "admin"){
                found = true;
            }
        });

        if(!found){
            alert("Access Denied. Admins Only.");
            location.href="login.html";
        }
    });

    loadUsers();
});

// Load all users
function loadUsers(){
    onSnapshot(collection(db,"users"), snap=>{
        usersBody.innerHTML = "";
        snap.forEach(d=>{
            let u = d.data();
            usersBody.innerHTML += `
              <tr>
                <td>${u.empID}</td>
                <td>${u.email}</td>
                <td>${u.role}</td>
                <td>${d.id}</td>
                <td>
                    <button class="blueBtn actionBtn"
                        onclick="resetUserPassword('${d.id}','${u.email}')">
                        Reset
                    </button>
                </td>
                <td>
                    <button class="redBtn actionBtn"
                        onclick="deleteUserAccount('${d.id}')">
                        Delete
                    </button>
                </td>
              </tr>
            `;
        });
    });
}

// Create Recruiter
async function createRecruiter(){
    let email = emailInput.value.trim();
    let pass = passwordInput.value.trim();

    if(!email || !pass){
        alert("Enter email and password");
        return;
    }

    // Extract EmpID from email prefix
    let empID = email.split("@")[0].toUpperCase();

    try {
        const newUser = await createUserWithEmailAndPassword(auth, email, pass);
        const uid = newUser.user.uid;

        // Store profile in Firestore
        await setDoc(doc(db,"users", uid), {
            empID,
            email,
            role: "recruiter"
        });

        alert("Recruiter Created Successfully");

        emailInput.value="";
        passwordInput.value="";

    } catch (err){
        alert("Error: " + err.message);
    }
}

// Reset Password
async function resetUserPassword(uid, email){
    let newPass = prompt(`Enter new password for ${email}:`);
    if(!newPass) return;

    try{
        const tmpAuth = getAuth();
        const user = await tmpAuth.getUser ? null : null;

        // Firebase does NOT allow admin to reset password of another user directly
        // Trick: create a temp sign-in
        await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:update?key=${auth._config.apiKey}`, {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({
                idToken: await auth.currentUser.getIdToken(),
                localId: uid,
                password: newPass,
                returnSecureToken: false
            })
        });

        alert("Password Updated");
    } catch(err){
        alert("Error: " + err.message);
    }
}

// Delete User (Auth + Firestore)
async function deleteUserAccount(uid){
    if(!confirm("Delete this user?")) return;

    try{
        // Delete from Firestore
        await deleteDoc(doc(db,"users", uid));

        // Delete from Auth API
        await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:delete?key=${auth._config.apiKey}`, {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({
                idToken: await auth.currentUser.getIdToken(),
                localId: uid
            })
        });

        alert("User Deleted");

    } catch(err){
        alert("Error: " + err.message);
    }
}

// Logout
function logout(){
    auth.signOut();
    location.href="login.html";
}

// Theme Toggle
function toggleTheme(){
    document.body.classList.toggle("light");
}

// Expose to window
window.createRecruiter = createRecruiter;
window.resetUserPassword = resetUserPassword;
window.deleteUserAccount = deleteUserAccount;
window.toggleTheme = toggleTheme;
window.logout = logout;

</script>
</body>
</html>
